# 紧急修复说明 - 2025-10-31

## 问题概述

### 问题 1: Monaco Editor 显示异常
- **现象**：编辑模板时，Playbook 编辑器只显示一个黑色横条，无法输入
- **原因**：编辑器容器高度未正确设置
- **状态**：✅ 已修复

### 问题 2: 定时任务数据库错误
- **现象**：访问定时任务页面时报错 `relation "ansible_schedules" does not exist`
- **原因**：`AnsibleSchedule` 模型未添加到自动迁移列表中
- **状态**：✅ 已修复

## 修复内容

### 1. MonacoEditor.vue 修复

**文件**：`frontend/src/components/MonacoEditor.vue`

**变更**：
- 为编辑器容器添加明确的最小高度 (`min-height: 300px`)
- 修复高度计算逻辑
- 确保子元素继承父容器高度

**具体改动**：
```vue
<!-- 模板部分 -->
<div 
  ref="editorContainer" 
  class="editor-wrapper"
  :class="{ 'fullscreen': isFullscreen }"
  :style="{ height: isFullscreen ? '100vh' : height }"
>
  <vue-monaco-editor
    v-model:value="editorValue"
    :language="language"
    :theme="theme"
    :options="editorOptions"
    @mount="handleMount"
    style="height: 100%;"
  />
</div>

<!-- 样式部分 -->
<style scoped>
.editor-wrapper {
  flex: 1;
  overflow: hidden;
  position: relative;
  min-height: 300px;
}

.editor-wrapper > div {
  height: 100%;
}
</style>
```

### 2. migrate.go 修复

**文件**：`backend/internal/model/migrate.go`

**变更**：
- 添加 `&AnsibleSchedule{}` 到 AutoMigrate 列表

**具体改动**：
```go
func AutoMigrate(db *gorm.DB) error {
	return db.AutoMigrate(
		// ... 其他模型
		&AnsibleTask{},
		&AnsibleTemplate{},
		&AnsibleLog{},
		&AnsibleInventory{},
		&AnsibleSSHKey{},
		&AnsibleSchedule{}, // ← 新添加
	)
}
```

## 部署步骤

### 方案 1: Docker 部署（生产环境）

```bash
# 1. 进入项目目录
cd /Users/jicki/jicki/github/kube-node-manager

# 2. 重新构建 Docker 镜像
make docker-build

# 3. 停止现有容器
docker-compose down

# 4. 启动新容器（自动执行数据库迁移）
docker-compose up -d

# 5. 查看日志确认启动成功
docker-compose logs -f kube-node-manager
```

**预期日志输出**：
```
Database migration completed successfully!
Starting Ansible schedule service...
Ansible schedule service started successfully
Server listening on :8080
```

### 方案 2: 开发环境快速测试

```bash
# 前端（终端 1）
cd /Users/jicki/jicki/github/kube-node-manager/frontend
npm run dev

# 后端（终端 2）
cd /Users/jicki/jicki/github/kube-node-manager/backend
go run cmd/main.go
```

### 方案 3: 仅执行数据库迁移

如果应用已经在运行，只需执行数据库迁移：

```bash
cd /Users/jicki/jicki/github/kube-node-manager/backend
go run tools/migrate.go
```

**预期输出**：
```
Starting database migration...
Database migration completed successfully!

Tables in database:
  - ansible_inventories
  - ansible_logs
  - ansible_schedules        ← 新创建的表
  - ansible_ssh_keys
  - ansible_tasks
  - ansible_templates
  - ... (其他表)
```

然后重启应用：
```bash
docker-compose restart kube-node-manager
```

## 验证步骤

### 验证 1: Monaco Editor

1. 访问应用并登录
2. 导航到 **Ansible** → **任务模板**
3. 点击 **"创建模板"** 按钮
4. 查看 Playbook 内容编辑器

**✅ 正确状态：**
- 显示深色主题代码编辑器
- 编辑器高度约 500px
- 左侧显示行号
- 顶部显示工具栏（格式化、撤销、重做、全屏）
- 可以正常输入和编辑 YAML 代码
- YAML 语法高亮正常

**❌ 错误状态（修复前）：**
- 只显示黑色横条
- 高度很小（约 20-30px）
- 无法输入

### 验证 2: 定时任务

1. 导航到 **Ansible** → **定时任务**
2. 页面应该正常加载，显示空列表或已有任务
3. 点击 **"创建定时任务"** 按钮
4. 应该能正常打开创建对话框

**✅ 正确状态：**
- 页面正常加载
- 表格显示正常
- 可以创建、编辑、删除定时任务
- Cron 表达式编辑正常

**❌ 错误状态（修复前）：**
- 页面报错或显示错误提示
- 控制台显示：`relation "ansible_schedules" does not exist`

### 验证 3: 数据库表

连接数据库检查表是否创建：

**PostgreSQL：**
```sql
\dt
-- 应该看到 ansible_schedules 表

\d ansible_schedules
-- 查看表结构
```

**SQLite：**
```bash
sqlite3 /path/to/kube-node-manager.db
.tables
-- 应该看到 ansible_schedules 表

.schema ansible_schedules
-- 查看表结构
```

## 浏览器缓存清理

如果修复后仍然看到旧版本，请清理浏览器缓存：

1. **Chrome/Edge**：Ctrl+Shift+Delete 或 Cmd+Shift+Delete
2. **Firefox**：Ctrl+Shift+Delete 或 Cmd+Shift+Delete
3. **或使用无痕/隐私模式**

也可以强制刷新：
- **Windows/Linux**：Ctrl+Shift+R
- **macOS**：Cmd+Shift+R

## 回滚方案

如果出现问题需要回滚：

```bash
# 1. 停止容器
docker-compose down

# 2. 切换到之前的版本
git checkout <previous-commit>

# 3. 重新构建
make docker-build

# 4. 启动
docker-compose up -d
```

## 影响范围

- **前端**：所有使用模板编辑功能的用户
- **后端**：定时任务功能
- **数据库**：新增 `ansible_schedules` 表

## 测试清单

- [x] Monaco Editor 正常显示
- [x] Monaco Editor 可以输入和编辑
- [x] 语法高亮正常工作
- [x] 工具栏功能正常（格式化、撤销、重做、全屏）
- [x] 定时任务页面正常加载
- [x] 可以创建定时任务
- [x] 可以编辑定时任务
- [x] 可以删除定时任务
- [x] 可以启用/禁用定时任务
- [x] 可以立即执行定时任务
- [x] Cron 表达式验证正常
- [x] 数据库表创建成功

## 相关文件

### 修改的文件
- `frontend/src/components/MonacoEditor.vue`
- `backend/internal/model/migrate.go`

### 参考文档
- `docs/monaco-editor-troubleshooting.md` - Monaco Editor 详细排查指南
- `docs/ansible-enhancement-progress.md` - Ansible 功能增强进度
- `docs/ansible-scheduling-guide.md` - 定时任务使用指南

## 支持信息

如果遇到问题，请提供以下信息：

1. **浏览器信息**
   - 浏览器类型和版本
   - 控制台错误信息（F12 → Console）
   - Network 请求详情（F12 → Network）

2. **后端日志**
   ```bash
   docker-compose logs -f kube-node-manager
   ```

3. **数据库版本**
   - PostgreSQL 或 SQLite
   - 版本号

4. **应用版本**
   ```bash
   cat VERSION
   ```

---

**修复时间**：2025-10-31  
**修复版本**：v1.0.14  
**修复人员**：AI Assistant  
**测试状态**：✅ 已测试  
**部署状态**：⏳ 待部署

