# Ansible 模块测试指南

## 测试概述

本指南提供 Ansible 模块功能测试的详细步骤和验证要点。

## 功能测试清单

### 一、定时任务调度测试

#### 1.1 创建定时任务

**测试步骤**：
1. 登录系统（admin 账号）
2. 导航到 **Ansible 任务** > **定时任务管理**
3. 点击 **创建定时任务**
4. 填写表单：
   - 任务名称：test-schedule
   - 模板：选择已有模板
   - 主机清单：选择已有清单
   - Cron 表达式：`*/5 * * * *`（每5分钟）
   - 启用状态：勾选
5. 点击 **确定**

**预期结果**：
- ✅ 任务创建成功
- ✅ 列表中显示新任务
- ✅ 状态为"已启用"
- ✅ 下次执行时间正确计算

#### 1.2 Cron 表达式验证

**测试用例**：

| Cron 表达式 | 是否有效 | 说明 |
|------------|---------|------|
| `0 * * * *` | ✅ | 每小时整点 |
| `*/5 * * * *` | ✅ | 每5分钟 |
| `0 0 * * *` | ✅ | 每天午夜 |
| `@daily` | ✅ | 每天执行 |
| `invalid` | ❌ | 无效表达式，应拒绝 |
| `99 * * * *` | ❌ | 分钟数超出范围 |

**预期结果**：
- ✅ 有效表达式可以保存
- ✅ 无效表达式拒绝并提示错误

#### 1.3 定时任务执行

**测试步骤**：
1. 创建一个简单的测试任务（如 ping 测试）
2. 设置 Cron 表达式为 `*/1 * * * *`（每分钟）
3. 等待任务自动执行
4. 检查 **Ansible 任务** 列表

**预期结果**：
- ✅ 任务在指定时间自动创建并执行
- ✅ 执行次数递增
- ✅ 上次执行时间更新
- ✅ 下次执行时间更新

#### 1.4 立即执行

**测试步骤**：
1. 选择一个已启用的定时任务
2. 点击 **立即执行** 按钮
3. 检查任务列表

**预期结果**：
- ✅ 任务立即创建并执行
- ✅ 不影响定时调度计划

#### 1.5 启用/禁用

**测试步骤**：
1. 点击 **禁用** 按钮
2. 等待下次预定执行时间
3. 点击 **启用** 按钮

**预期结果**：
- ✅ 禁用后任务不自动执行
- ✅ 启用后恢复自动执行

#### 1.6 编辑定时任务

**测试步骤**：
1. 点击 **编辑** 按钮
2. 修改 Cron 表达式
3. 保存

**预期结果**：
- ✅ 修改保存成功
- ✅ 下次执行时间重新计算
- ✅ 调度器自动重新加载

#### 1.7 删除定时任务

**测试步骤**：
1. 点击 **删除** 按钮
2. 确认删除

**预期结果**：
- ✅ 任务从列表中移除
- ✅ 调度器停止该任务

### 二、失败重试机制测试

#### 2.1 配置重试策略

**测试步骤**：
1. 创建一个会失败的任务（如连接不存在的主机）
2. 在创建时配置重试策略：
```json
{
  "retry_policy": {
    "max_retries": 3,
    "retry_interval": 10,
    "retry_on_error": true
  }
}
```
3. 执行任务

**预期结果**：
- ✅ 任务失败后自动重试
- ✅ 重试次数正确记录
- ✅ 重试间隔正确
- ✅ 达到最大次数后停止

#### 2.2 不同重试策略

**测试用例**：

| 策略 | max_retries | retry_interval | 预期行为 |
|------|-------------|----------------|----------|
| 启用重试 | 3 | 30 | 重试3次，每次间隔30秒 |
| 禁用重试 | 0 | 0 | 失败后不重试 |
| 快速重试 | 5 | 5 | 重试5次，每次间隔5秒 |

### 三、环境保护测试

#### 3.1 生产环境保护

**测试步骤**：
1. 创建一个生产环境清单（environment: production）
2. 创建任务选择该清单
3. 点击启动任务

**预期结果**：
- ✅ 弹出二次确认对话框
- ✅ 显示"生产环境"警告
- ✅ 必须勾选确认框才能执行
- ✅ 点击取消可以取消操作

#### 3.2 高风险模板保护

**测试步骤**：
1. 创建一个高风险模板（risk_level: high）
2. 创建任务选择该模板
3. 点击启动任务

**预期结果**：
- ✅ 弹出二次确认对话框
- ✅ 显示"高风险操作"警告
- ✅ 必须勾选确认框才能执行

#### 3.3 组合保护

**测试步骤**：
1. 使用生产环境清单 + 高风险模板
2. 创建任务
3. 点击启动任务

**预期结果**：
- ✅ 弹出严格确认对话框
- ✅ 显示"生产环境 + 高风险操作"警告
- ✅ 警告级别为 error（红色）

### 四、UI 增强功能测试

#### 4.1 模板快速筛选

**测试步骤**：
1. 导航到 **任务模板** 页面
2. 点击风险等级标签（低风险/中风险/高风险）

**预期结果**：
- ✅ 列表根据风险等级筛选
- ✅ 选中的标签高亮显示
- ✅ 筛选响应迅速

#### 4.2 模板克隆

**测试步骤**：
1. 选择一个模板
2. 点击 **克隆** 按钮
3. 修改名称
4. 保存

**预期结果**：
- ✅ 打开编辑对话框
- ✅ 名称自动添加"- 副本"后缀
- ✅ 所有字段正确复制
- ✅ 保存后创建新模板

#### 4.3 批量删除任务

**测试步骤**：
1. 选择多个已完成的任务
2. 点击 **批量删除** 按钮
3. 确认删除

**预期结果**：
- ✅ 只能选择已完成/失败/取消的任务
- ✅ 运行中的任务无法选择
- ✅ 成功删除所有选中任务

#### 4.4 增强日志查看器

**测试步骤**：
1. 查看任务日志
2. 在搜索框输入关键字
3. 选择日志级别过滤
4. 点击下载按钮

**预期结果**：
- ✅ 搜索结果高亮显示
- ✅ 日志级别过滤正确
- ✅ 可以复制日志
- ✅ 可以下载日志文件
- ✅ 显示行号和时间戳
- ✅ 自动滚动功能正常

### 五、权限和安全测试

#### 5.1 Admin 权限

**测试步骤**：
1. 使用 admin 账号登录
2. 访问所有 Ansible 功能

**预期结果**：
- ✅ 可以访问所有功能
- ✅ 可以执行所有操作

#### 5.2 普通用户权限（如果实施了权限控制）

**测试步骤**：
1. 使用普通用户登录
2. 尝试访问 Ansible 功能

**预期结果**：
- ✅ 无法访问（当前设计）
- ⚠️ 或根据权限控制显示相应功能

### 六、性能测试

#### 6.1 定时任务数量限制

**测试步骤**：
1. 创建大量定时任务（接近100个）
2. 尝试创建第101个任务

**预期结果**：
- ✅ 系统正常运行
- ✅ 达到限制后拒绝创建或提示

#### 6.2 并发任务执行

**测试步骤**：
1. 创建多个定时任务在同一时间触发
2. 观察任务执行

**预期结果**：
- ✅ 最多同时执行5个任务
- ✅ 其他任务排队等待
- ✅ 系统资源使用正常

#### 6.3 大日志处理

**测试步骤**：
1. 执行一个生成大量日志的任务
2. 查看日志

**预期结果**：
- ✅ 日志查看器限制最大行数（10000行）
- ✅ 页面不卡顿
- ✅ 搜索功能正常

### 七、异常情况测试

#### 7.1 网络故障

**测试场景**：
- 主机不可达
- SSH 连接超时
- 网络中断

**预期结果**：
- ✅ 任务标记为失败
- ✅ 错误信息清晰
- ✅ 如果配置了重试，自动重试

#### 7.2 无效 Playbook

**测试步骤**：
1. 创建包含语法错误的模板
2. 执行任务

**预期结果**：
- ✅ 任务失败
- ✅ 显示 Ansible 错误信息
- ✅ 不会导致系统崩溃

#### 7.3 系统重启

**测试步骤**：
1. 创建定时任务并启用
2. 重启后端服务
3. 检查定时任务状态

**预期结果**：
- ✅ 服务重启后自动加载定时任务
- ✅ 调度继续正常工作
- ✅ 下次执行时间正确

### 八、数据库测试

#### 8.1 数据完整性

**测试步骤**：
1. 执行各种操作（创建、更新、删除）
2. 检查数据库

**预期结果**：
- ✅ 外键关系正确
- ✅ 软删除正常工作
- ✅ 索引生效
- ✅ 数据一致性

#### 8.2 迁移测试

**测试步骤**：
1. 从旧版本数据库升级
2. 运行迁移脚本
3. 验证数据

**预期结果**：
- ✅ 迁移成功完成
- ✅ 现有数据保留
- ✅ 新字段有默认值
- ✅ 应用正常运行

## 测试工具

### 手动测试

使用浏览器进行功能测试：
- Chrome/Firefox 开发者工具
- 检查网络请求
- 查看控制台错误

### API 测试

使用 curl 或 Postman 测试 API：

```bash
# 列出定时任务
curl -X GET http://localhost:8080/api/v1/ansible/schedules \
  -H "Authorization: Bearer YOUR_TOKEN"

# 创建定时任务
curl -X POST http://localhost:8080/api/v1/ansible/schedules \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "test-schedule",
    "template_id": 1,
    "inventory_id": 1,
    "cron_expr": "*/5 * * * *",
    "enabled": true
  }'
```

### 数据库检查

```bash
# SQLite
sqlite3 data/kube-node-manager.db

# 检查定时任务表
SELECT * FROM ansible_schedules;

# 检查任务重试信息
SELECT id, name, retry_count, max_retries FROM ansible_tasks WHERE retry_count > 0;
```

### 日志监控

```bash
# 查看应用日志
tail -f logs/app.log | grep -i schedule

# 查看调度器日志
tail -f logs/app.log | grep -i cron
```

## 测试报告模板

### 测试报告

**测试日期**：YYYY-MM-DD  
**测试人员**：姓名  
**版本号**：v2.19.0  

#### 功能测试结果

| 功能模块 | 测试用例数 | 通过 | 失败 | 状态 |
|---------|----------|------|------|------|
| 定时任务调度 | 7 | 7 | 0 | ✅ |
| 失败重试 | 2 | 2 | 0 | ✅ |
| 环境保护 | 3 | 3 | 0 | ✅ |
| UI 增强 | 4 | 4 | 0 | ✅ |
| 权限控制 | 2 | 2 | 0 | ✅ |

#### 发现的问题

| 问题ID | 严重程度 | 描述 | 状态 |
|--------|---------|------|------|
| - | - | - | - |

#### 性能测试结果

- 定时任务数量：100 个 - ✅ 正常
- 并发执行：5 个 - ✅ 正常
- 日志处理：10000 行 - ✅ 正常

#### 结论

所有核心功能测试通过，系统稳定可靠，可以发布。

## 持续集成

### 自动化测试（待实施）

建议未来实施：
- 单元测试（Go Test）
- 前端单元测试（Vitest）
- E2E 测试（Playwright）
- API 集成测试

### CI/CD 流程

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run Backend Tests
        run: |
          cd backend
          go test ./...
      - name: Run Frontend Tests
        run: |
          cd frontend
          npm test
```

## 最佳实践

1. **测试前准备**
   - 备份数据库
   - 使用测试环境
   - 准备测试数据

2. **测试执行**
   - 按照测试清单逐项测试
   - 记录所有发现的问题
   - 截图保存证据

3. **问题跟踪**
   - 详细描述问题
   - 记录重现步骤
   - 及时修复和验证

4. **回归测试**
   - 修复后重新测试
   - 验证不影响其他功能
   - 性能对比

## 相关文档

- [定时任务调度指南](./ansible-scheduling-guide.md)
- [功能实施进度](./ansible-enhancement-progress.md)
- [版本功能总结](./ansible-v2.19-features.md)
- [故障排查指南](./ansible-troubleshooting.md)

---

**文档版本**：v1.0  
**最后更新**：2025-10-31  
**维护人员**：开发团队

