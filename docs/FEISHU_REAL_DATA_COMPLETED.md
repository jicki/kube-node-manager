# é£ä¹¦æœºå™¨äººçœŸå®æ•°æ®é›†æˆ - å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. æ·»åŠ æœåŠ¡ä¾èµ–æ³¨å…¥

**æ–‡ä»¶**: `backend/internal/service/feishu/feishu.go`

- å®šä¹‰äº† `ClusterServiceInterface` å’Œ `NodeServiceInterface`
- åœ¨ `Service` ç»“æ„ä½“ä¸­æ·»åŠ äº†æœåŠ¡å¼•ç”¨
- æ·»åŠ äº† `SetClusterService` å’Œ `SetNodeService` æ–¹æ³•

### 2. é…ç½®æœåŠ¡ä¾èµ–å…³ç³»

**æ–‡ä»¶**: `backend/internal/service/services.go`

- åœ¨ `NewServices` å‡½æ•°ä¸­è®¾ç½®é£ä¹¦æœåŠ¡çš„ä¾èµ–
- é€šè¿‡ `feishuSvc.SetClusterService(clusterSvc)` æ³¨å…¥é›†ç¾¤æœåŠ¡
- é€šè¿‡ `feishuSvc.SetNodeService(nodeSvc)` æ³¨å…¥èŠ‚ç‚¹æœåŠ¡

### 3. ä¿®æ”¹å‘½ä»¤å¤„ç†å™¨è°ƒç”¨çœŸå®æœåŠ¡

**æ–‡ä»¶**: `backend/internal/service/feishu/command_node.go`

#### 3.1 `handleListClusters` - æ˜¾ç¤ºçœŸå®é›†ç¾¤åˆ—è¡¨

- è°ƒç”¨ `cluster.Service.List()` è·å–æ‰€æœ‰é›†ç¾¤
- è½¬æ¢ä¸ºå¡ç‰‡æ ¼å¼æ˜¾ç¤º
- æ˜¾ç¤ºé›†ç¾¤åç§°ã€çŠ¶æ€ã€èŠ‚ç‚¹æ•°é‡
- ç©ºé›†ç¾¤æ—¶ç»™å‡ºå‹å¥½æç¤º

#### 3.2 `handleListNodes` - æ˜¾ç¤ºçœŸå®èŠ‚ç‚¹åˆ—è¡¨

- è°ƒç”¨ `node.Service.List()` è·å–å½“å‰é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹
- è½¬æ¢ä¸ºå¡ç‰‡æ ¼å¼æ˜¾ç¤º
- æ˜¾ç¤ºèŠ‚ç‚¹åç§°ã€çŠ¶æ€ã€è°ƒåº¦çŠ¶æ€
- å¤„ç†å„ç§é”™è¯¯æƒ…å†µ

#### 3.3 `handleNodeInfo` - æ˜¾ç¤ºçœŸå®èŠ‚ç‚¹è¯¦æƒ…

- è·å–èŠ‚ç‚¹åˆ—è¡¨å¹¶æŸ¥æ‰¾æŒ‡å®šèŠ‚ç‚¹
- æ˜¾ç¤ºèŠ‚ç‚¹å®Œæ•´ä¿¡æ¯ï¼š
  - èŠ‚ç‚¹åç§°
  - çŠ¶æ€ï¼ˆReady/NotReadyï¼‰
  - è°ƒåº¦çŠ¶æ€
  - IP åœ°å€
  - å®¹å™¨è¿è¡Œæ—¶
  - å†…æ ¸ç‰ˆæœ¬
  - æ“ä½œç³»ç»Ÿ

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ä¹‹å‰ âŒ
```
- åªæ˜¾ç¤ºç¡¬ç¼–ç çš„2ä¸ªé›†ç¾¤ï¼ˆdefault, test-k8s-clusterï¼‰
- åªæ˜¾ç¤ºç¡¬ç¼–ç çš„2ä¸ªèŠ‚ç‚¹ï¼ˆnode-1, node-2ï¼‰
- èŠ‚ç‚¹ä¿¡æ¯æ˜¯å‡æ•°æ®
```

### ç°åœ¨ âœ…
```
- æ˜¾ç¤ºç³»ç»Ÿä¸­é…ç½®çš„æ‰€æœ‰çœŸå®é›†ç¾¤ï¼ˆ8ä¸ªï¼‰
- æ˜¾ç¤ºå®é™…é›†ç¾¤ä¸­çš„çœŸå®èŠ‚ç‚¹
- èŠ‚ç‚¹åç§°å¦‚ï¼š10-9-9-28.vm.pd.sz.deeproute.ai
- èŠ‚ç‚¹ä¿¡æ¯æ¥è‡ª Kubernetes API
```

## ğŸš€ ä½¿ç”¨æµç¨‹

### 1. æŸ¥çœ‹æ‰€æœ‰é›†ç¾¤
```
/node list
```
**æ˜¾ç¤º**ï¼š
- test-k8s-cluster (ğŸŸ¢ å¥åº· | èŠ‚ç‚¹æ•°: 2)
- prod-data-k8s-cluster (ğŸŸ¢ å¥åº· | èŠ‚ç‚¹æ•°: 5)
- prod-k8s-cluster (ğŸŸ¢ å¥åº· | èŠ‚ç‚¹æ•°: 8)
- ...ï¼ˆæ‰€æœ‰ç³»ç»Ÿä¸­çš„é›†ç¾¤ï¼‰

### 2. é€‰æ‹©é›†ç¾¤
```
/node set test-k8s-cluster
```
**æ˜¾ç¤º**ï¼š
```
âœ… å·²åˆ‡æ¢åˆ°é›†ç¾¤: test-k8s-cluster

ç°åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤:
â€¢ /node nodes - æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨
â€¢ /node info <èŠ‚ç‚¹å> - æŸ¥çœ‹èŠ‚ç‚¹è¯¦æƒ…
â€¢ /node cordon <èŠ‚ç‚¹å> - ç¦æ­¢è°ƒåº¦
â€¢ /node uncordon <èŠ‚ç‚¹å> - æ¢å¤è°ƒåº¦
```

### 3. æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨
```
/node nodes
```
**æ˜¾ç¤º**ï¼š
- 10-9-9-28.vm.pd.sz.deeproute.ai (ğŸŸ¢ Ready | âœ… å¯è°ƒåº¦)
- 10-9-9-30.vm.pd.sz.deeproute.ai (ğŸŸ¢ Ready | â›” ç¦æ­¢è°ƒåº¦)
- ...ï¼ˆå®é™…çš„èŠ‚ç‚¹åˆ—è¡¨ï¼‰

### 4. æŸ¥çœ‹èŠ‚ç‚¹è¯¦æƒ…
```
/node info 10-9-9-28.vm.pd.sz.deeproute.ai
```
**æ˜¾ç¤º**ï¼š
```
èŠ‚ç‚¹åç§°: 10-9-9-28.vm.pd.sz.deeproute.ai
çŠ¶æ€: ğŸŸ¢ Ready
è°ƒåº¦çŠ¶æ€: âœ… å¯è°ƒåº¦
IP åœ°å€: 10.9.9.28
å®¹å™¨è¿è¡Œæ—¶: containerd://1.24.17
å†…æ ¸ç‰ˆæœ¬: 5.10.0-28-amd64
æ“ä½œç³»ç»Ÿ: Ubuntu 20.04.6 LTS
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æœåŠ¡æ¥å£è®¾è®¡

ä½¿ç”¨interface{}ç±»å‹æ¥é¿å…å¾ªç¯ä¾èµ–ï¼š

```go
type ClusterServiceInterface interface {
    List(req interface{}, userID uint) (interface{}, error)
}

type NodeServiceInterface interface {
    List(req interface{}, userID uint) (interface{}, error)
    Get(req interface{}, userID uint) (interface{}, error)
}
```

### ç±»å‹è½¬æ¢

åœ¨è°ƒç”¨æœåŠ¡åè¿›è¡Œç±»å‹æ–­è¨€ï¼š

```go
// é›†ç¾¤åˆ—è¡¨
listResp, ok := result.(*cluster.ListResponse)

// èŠ‚ç‚¹åˆ—è¡¨
nodeInfos, ok := result.([]k8s.NodeInfo)
```

### é”™è¯¯å¤„ç†

- æœåŠ¡æœªé…ç½®ï¼šæç¤º"æœåŠ¡æœªé…ç½®"
- è·å–æ•°æ®å¤±è´¥ï¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯å¹¶å»ºè®®æ£€æŸ¥è¿æ¥
- ç©ºæ•°æ®ï¼šç»™å‡ºå‹å¥½æç¤º
- èŠ‚ç‚¹ä¸å­˜åœ¨ï¼šæ˜ç¡®å‘ŠçŸ¥èŠ‚ç‚¹åå’Œé›†ç¾¤å

## ğŸ”’ æƒé™æ§åˆ¶

æ‰€æœ‰æ“ä½œéƒ½ä½¿ç”¨ `ctx.UserMapping.SystemUserID` ä½œä¸ºç”¨æˆ·IDï¼š

```go
result, err := ctx.Service.nodeService.List(node.ListRequest{
    ClusterName: clusterName,
}, ctx.UserMapping.SystemUserID)
```

è¿™ç¡®ä¿äº†ï¼š
- æ“ä½œä¼šè¢«å®¡è®¡
- æƒé™æ£€æŸ¥æ­£å¸¸å·¥ä½œ
- ç”¨æˆ·åªèƒ½è®¿é—®æœ‰æƒé™çš„èµ„æº

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. `backend/internal/service/feishu/feishu.go` - æ·»åŠ æœåŠ¡æ¥å£
2. `backend/internal/service/services.go` - é…ç½®æœåŠ¡ä¾èµ–
3. `backend/internal/service/feishu/command_node.go` - ä¿®æ”¹å‘½ä»¤å¤„ç†å™¨

### æ–°å¢çš„æ•°æ®åº“è¡¨
4. `feishu_user_sessions` - ç”¨æˆ·ä¼šè¯ç®¡ç†ï¼ˆå­˜å‚¨å½“å‰é€‰æ‹©çš„é›†ç¾¤ï¼‰

### æ–‡æ¡£
5. `docs/feishu-bot-session-management.md` - ä¼šè¯ç®¡ç†è¯´æ˜
6. `docs/FEISHU_BOT_REAL_DATA_INTEGRATION.md` - é›†æˆè¯´æ˜
7. `docs/FEISHU_REAL_DATA_COMPLETED.md` - å®Œæˆæ€»ç»“ï¼ˆæœ¬æ–‡æ¡£ï¼‰

## ğŸ¯ æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: é‡å¯åº”ç”¨

```bash
cd /Users/jicki/jicki/github/kube-node-manager/backend
# åœæ­¢å½“å‰åº”ç”¨ï¼ˆCtrl+Cï¼‰
go run cmd/main.go
```

### æ­¥éª¤ 2: æµ‹è¯•é›†ç¾¤åˆ—è¡¨

åœ¨é£ä¹¦ä¸­å‘é€ï¼š
```
/node list
```

åº”è¯¥èƒ½çœ‹åˆ°ç³»ç»Ÿä¸­é…ç½®çš„æ‰€æœ‰é›†ç¾¤ï¼ˆ8ä¸ªï¼‰ã€‚

### æ­¥éª¤ 3: åˆ‡æ¢é›†ç¾¤

```
/node set test-k8s-cluster
```

åº”è¯¥æ”¶åˆ°åˆ‡æ¢æˆåŠŸçš„æç¤ºã€‚

### æ­¥éª¤ 4: æŸ¥çœ‹èŠ‚ç‚¹

```
/node nodes
```

åº”è¯¥çœ‹åˆ°çœŸå®çš„èŠ‚ç‚¹åˆ—è¡¨ï¼ŒèŠ‚ç‚¹åç§°å¦‚ `10-9-9-28.vm.pd.sz.deeproute.ai`ã€‚

### æ­¥éª¤ 5: æŸ¥çœ‹èŠ‚ç‚¹è¯¦æƒ…

```
/node info 10-9-9-28.vm.pd.sz.deeproute.ai
```

åº”è¯¥çœ‹åˆ°å®Œæ•´çš„èŠ‚ç‚¹ä¿¡æ¯ã€‚

## âœ… é¢„æœŸæµ‹è¯•ç»“æœ

- âœ… é›†ç¾¤åˆ—è¡¨æ˜¾ç¤º8ä¸ªé›†ç¾¤
- âœ… èŠ‚ç‚¹åˆ—è¡¨æ˜¾ç¤ºçœŸå®èŠ‚ç‚¹åç§°
- âœ… èŠ‚ç‚¹è¯¦æƒ…æ˜¾ç¤ºçœŸå®ä¿¡æ¯
- âœ… é”™è¯¯æç¤ºå‹å¥½ä¸”å‡†ç¡®
- âœ… ç©ºé›†ç¾¤æ—¶ç»™å‡ºæ­£ç¡®æç¤º

## ğŸ› å¯èƒ½çš„é—®é¢˜

### é—®é¢˜ 1: æ˜¾ç¤º"é›†ç¾¤æœåŠ¡æœªé…ç½®"

**åŸå› **ï¼šæœåŠ¡ä¾èµ–æ³¨å…¥å¤±è´¥

**è§£å†³**ï¼šæ£€æŸ¥ `services.go` ä¸­æ˜¯å¦æ­£ç¡®è®¾ç½®äº†æœåŠ¡ä¾èµ–

### é—®é¢˜ 2: æ˜¾ç¤º"æ•°æ®æ ¼å¼é”™è¯¯"

**åŸå› **ï¼šç±»å‹æ–­è¨€å¤±è´¥

**è§£å†³**ï¼šæ£€æŸ¥è¿”å›ç±»å‹æ˜¯å¦åŒ¹é…æ¥å£å®šä¹‰

### é—®é¢˜ 3: æ˜¾ç¤º"è·å–é›†ç¾¤åˆ—è¡¨å¤±è´¥"

**åŸå› **ï¼šé›†ç¾¤æœåŠ¡è°ƒç”¨å¤±è´¥

**è§£å†³**ï¼š
- æ£€æŸ¥æ•°æ®åº“è¿æ¥
- æ£€æŸ¥ç”¨æˆ·æƒé™
- æŸ¥çœ‹åº”ç”¨æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯

## ğŸ‰ æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¿®æ”¹ï¼š

1. âœ… é£ä¹¦æœºå™¨äººç°åœ¨æ˜¾ç¤ºçœŸå®çš„é›†ç¾¤å’ŒèŠ‚ç‚¹æ•°æ®
2. âœ… ç”¨æˆ·å¯ä»¥æŸ¥çœ‹ç³»ç»Ÿä¸­é…ç½®çš„æ‰€æœ‰é›†ç¾¤
3. âœ… èŠ‚ç‚¹ä¿¡æ¯å‡†ç¡®åæ˜  Kubernetes å®é™…çŠ¶æ€
4. âœ… é”™è¯¯å¤„ç†å‹å¥½ä¸”å®Œå–„
5. âœ… ä¼šè¯ç®¡ç†ä½¿æ“ä½œæ›´ä¾¿æ·

---

**ä¿®æ”¹å®Œæˆæ—¶é—´**ï¼š2025/10/17  
**ç‰ˆæœ¬**ï¼šv2.2 - çœŸå®æ•°æ®é›†æˆ

