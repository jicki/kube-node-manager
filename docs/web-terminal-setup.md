# Web终端配置指南

本文档说明如何配置Web终端功能所需的SSH密钥。

## 问题现象

在节点管理页面点击"Web终端"按钮后，SSH连接配置对话框中的"使用密钥"下拉框显示"无数据"或提示"系统中暂无SSH密钥"。

## 原因分析

Web终端功能需要使用系统SSH密钥来连接到节点。如果系统中没有配置SSH密钥，就无法建立连接。

## 解决方案

### 步骤1: 准备SSH密钥

首先需要准备一个可以连接到Kubernetes节点的SSH私钥。您可以：

1. **使用现有密钥**：如果已经有可以SSH到节点的密钥，可以直接使用
2. **生成新密钥**：
   ```bash
   ssh-keygen -t rsa -b 4096 -C "your_email@example.com" -f ~/.ssh/k8s_node_key
   ```

3. **将公钥部署到节点**：
   ```bash
   # 将公钥复制到所有节点
   ssh-copy-id -i ~/.ssh/k8s_node_key.pub user@node-ip
   ```

### 步骤2: 在系统中创建SSH密钥

1. 登录系统（需要Admin权限）

2. 导航到 **SSH密钥管理** 页面：
   - 侧边栏: 系统设置 -> SSH密钥管理
   - 或直接访问: `http://your-domain/ssh-keys`

3. 点击 **创建密钥** 按钮

4. 填写SSH密钥信息：
   ```
   名称: devops key (或其他描述性名称)
   描述: 用于连接K8s节点的SSH密钥
   类型: ssh_key
   用户名: root (或您的SSH用户名，如ubuntu、centos等)
   SSH端口: 22 (默认)
   私钥: [粘贴您的SSH私钥内容]
   密码短语: [如果私钥有密码，请填写]
   设为默认: ✓ (勾选此项)
   ```

5. 点击 **保存** 按钮

### 步骤3: 验证配置

1. 返回 **节点管理** 页面

2. 点击任意节点的 **Web终端** 按钮

3. 在SSH连接配置对话框中：
   - "使用密钥"下拉框应该显示您刚才创建的密钥
   - "SSH用户"会自动填充密钥中配置的用户名
   - 可以修改SSH端口（默认22）

4. 点击 **保存并重连** 按钮

5. 如果配置正确，终端应该显示 "Connected to server..." 并出现命令行提示符

## 常见问题

### Q1: 提示"connection error"

**可能原因**:
- SSH密钥无权限连接到节点
- 节点IP地址不正确
- 节点SSH端口不是22（需要在配置中修改）
- 防火墙阻止了SSH连接

**解决方法**:
1. 在SSH密钥管理页面，点击密钥的"测试连接"按钮，填入节点IP测试
2. 检查节点的SSH服务是否正常运行
3. 确认网络连通性

### Q2: 提示"authentication failed"

**可能原因**:
- 私钥与节点上的公钥不匹配
- SSH用户名不正确
- 私钥密码短语填写错误

**解决方法**:
1. 确认私钥对应的公钥已经部署到节点
2. 检查SSH用户名是否正确（root、ubuntu、centos等）
3. 如果私钥有密码，确认密码短语填写正确

### Q3: 可以连接但没有权限执行命令

**可能原因**:
- SSH用户权限不足
- 需要sudo权限但未配置

**解决方法**:
1. 使用root用户或配置sudo免密码
2. 在节点上执行: `visudo` 添加用户到sudo组

## 安全建议

1. **密钥权限**：
   - 使用独立的SSH密钥，不要使用个人密钥
   - 私钥文件权限应为600: `chmod 600 ~/.ssh/k8s_node_key`

2. **用户权限**：
   - 建议创建专门的运维用户，而不是直接使用root
   - 配置sudo权限而非直接root登录

3. **密钥轮换**：
   - 定期更换SSH密钥（建议每季度一次）
   - 旧密钥失效时及时从节点删除公钥

4. **审计日志**：
   - 系统会记录所有Web终端的使用日志
   - 管理员可以在审计日志中查看操作记录

## 架构说明

Web终端的连接流程：

```
浏览器 <--WebSocket--> 后端服务 <--SSH--> Kubernetes节点
         (wss://)               (port 22)
```

- 前端通过WebSocket连接到后端
- 后端使用配置的SSH密钥建立到节点的SSH连接
- 终端输入输出通过WebSocket双向传输

## 相关文档

- [SSH密钥迁移说明](./ssh-key-migration-summary.md)
- [系统架构文档](./microservice-architecture.md)

## 技术支持

如遇到其他问题，请：
1. 查看后端日志: `kubectl logs -f deployment/kube-node-manager`
2. 检查数据库中的`system_ssh_keys`表
3. 联系系统管理员或提交Issue

