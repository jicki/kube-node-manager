# è¿›åº¦æ¡å¡ä½é—®é¢˜ä¿®å¤éªŒè¯æŒ‡å—

## é—®é¢˜ç—‡çŠ¶
- æ‰¹é‡æ“ä½œè¿›åº¦æ¡è¾¾åˆ°100%åä¸æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
- æ“ä½œå®Œæˆä½†ç”¨æˆ·ç•Œé¢åœç•™åœ¨å¤„ç†ä¸­çŠ¶æ€
- å¤šå‰¯æœ¬ç¯å¢ƒä¸‹WebSocketè¿æ¥å’Œä»»åŠ¡çŠ¶æ€ä¸åŒæ­¥

## ä¿®å¤å†…å®¹æ¦‚è¿°

### 1. æ•°æ®åº“æ¨¡å¼ä¼˜åŒ– âœ…
- **æ›´å¿«è½®è¯¢**ï¼š500msé—´éš”å¤„ç†æœªå‘é€æ¶ˆæ¯ï¼ˆåŸ1ç§’ï¼‰
- **ä¼˜å…ˆå¤„ç†**ï¼šå®Œæˆæ¶ˆæ¯ä¼˜å…ˆäºæ™®é€šè¿›åº¦æ¶ˆæ¯
- **é‡è¯•æœºåˆ¶**ï¼šé‡è¦æ¶ˆæ¯æ·»åŠ 100msé‡è¯•å»¶è¿Ÿ
- **å¼ºåˆ¶æ¨é€**ï¼šä»»åŠ¡å®Œæˆåç«‹å³æ¨é€ï¼Œä¸ç­‰å¾…è½®è¯¢

### 2. WebSocketè¿æ¥æ”¹è¿› âœ…
- **æ™ºèƒ½é‡è¿**ï¼šæ£€æµ‹åˆ°100%è¿›åº¦ä½†æœªå®Œæˆæ—¶è‡ªåŠ¨é‡è¿
- **å‡å°‘å»¶è¿Ÿ**ï¼šé‡è¿é—´éš”ä»2ç§’ç¼©çŸ­åˆ°1ç§’
- **è¿æ¥æ¢å¤**ï¼šé‡è¿åç«‹å³æ£€æŸ¥æœªå¤„ç†çš„æ•°æ®åº“æ¶ˆæ¯

### 3. å‰ç«¯å®Œæˆæ£€æµ‹ âœ…
- **å®Œæˆå®šæ—¶å™¨**ï¼šè¿›åº¦100%å3ç§’å†…æœªæ”¶åˆ°å®Œæˆæ¶ˆæ¯è‡ªåŠ¨é‡è¿
- **çŠ¶æ€è¿½è¸ª**ï¼šæ›´å‡†ç¡®çš„å®ŒæˆçŠ¶æ€åˆ¤æ–­
- **å®šæ—¶å™¨æ¸…ç†**ï¼šé˜²æ­¢å†…å­˜æ³„æ¼

## éªŒè¯æ­¥éª¤

### é¢„å¤‡å·¥ä½œ
1. **ç¡®è®¤æ•°æ®åº“æ¨¡å¼å·²å¯ç”¨**
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
kubectl get pods kube-node-mgr-0 -n kube-node-mgr -o yaml | grep PROGRESS_ENABLE_DATABASE

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
kubectl logs kube-node-mgr-0 -n kube-node-mgr | grep "database mode"
```

2. **æ£€æŸ¥å¤šå‰¯æœ¬è¿è¡ŒçŠ¶æ€**
```bash
kubectl get pods -n kube-node-mgr -l app=kube-node-mgr
```

### æµ‹è¯•ç”¨ä¾‹1ï¼šæ­£å¸¸å®Œæˆæµç¨‹
1. å¯åŠ¨æ‰¹é‡æ±¡ç‚¹æ“ä½œï¼ˆé€‰æ‹©7ä¸ªèŠ‚ç‚¹ï¼‰
2. è§‚å¯Ÿè¿›åº¦æ¡æ­£å¸¸æ¨è¿›åˆ°100%
3. **é¢„æœŸç»“æœ**ï¼š3ç§’å†…æ˜¾ç¤º"æ‰¹é‡æ“ä½œå®Œæˆ"å¹¶è‡ªåŠ¨å…³é—­

**å…³é”®æ—¥å¿—ç›‘æ§**ï¼š
```bash
kubectl logs -f statefulset/kube-node-mgr -n kube-node-mgr | grep -E "completed successfully|Force pushed|completion message"
```

### æµ‹è¯•ç”¨ä¾‹2ï¼šWebSocketæ–­å¼€æ¢å¤
1. å¯åŠ¨æ‰¹é‡æ“ä½œ
2. åœ¨è¿›åº¦80%æ—¶åˆ·æ–°é¡µé¢ï¼ˆæ¨¡æ‹Ÿè¿æ¥æ–­å¼€ï¼‰
3. **é¢„æœŸç»“æœ**ï¼šé‡æ–°è¿æ¥åç»§ç»­æ˜¾ç¤ºæ­£ç¡®è¿›åº¦å¹¶æ­£å¸¸å®Œæˆ

**å…³é”®æ—¥å¿—ç›‘æ§**ï¼š
```bash
kubectl logs -f statefulset/kube-node-mgr -n kube-node-mgr | grep -E "WebSocket connected|processUnsentMessages|Sent.*message to connected user"
```

### æµ‹è¯•ç”¨ä¾‹3ï¼š100%å¡ä½ä¿®å¤
1. å¯åŠ¨æ‰¹é‡æ“ä½œå¹¶è§‚å¯Ÿåˆ°100%
2. å¦‚æœæœªæ˜¾ç¤ºå®Œæˆï¼ˆæ¨¡æ‹Ÿæ—§é—®é¢˜ï¼‰
3. **é¢„æœŸç»“æœ**ï¼š3ç§’åè‡ªåŠ¨é‡è¿å¹¶æ”¶åˆ°å®Œæˆæ¶ˆæ¯

**å‰ç«¯æ§åˆ¶å°ç›‘æ§**ï¼š
```javascript
// æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹Consoleè¾“å‡º
"è¿›åº¦è¾¾åˆ°100%ï¼Œå¯åŠ¨å®Œæˆæ£€æŸ¥å®šæ—¶å™¨"
"è¿›åº¦100%åæœªæ”¶åˆ°å®Œæˆæ¶ˆæ¯ï¼Œå°è¯•é‡è¿è·å–çŠ¶æ€"
"é‡è¿WebSocketä»¥æ¥æ”¶å¯èƒ½çš„å®Œæˆæ¶ˆæ¯"
```

## æ€§èƒ½éªŒè¯

### æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ
**æ­£å¸¸æƒ…å†µ**ï¼šå®Œæˆæ¶ˆæ¯åœ¨500mså†…æ¨é€
```bash
# ç›‘æ§æ¶ˆæ¯å¤„ç†æ—¶é—´
kubectl logs -f statefulset/kube-node-mgr -n kube-node-mgr | grep -E "Processing.*unsent messages|Force pushed" | ts '[%Y-%m-%d %H:%M:%S]'
```

### æ•°æ®åº“æŸ¥è¯¢é¢‘ç‡
**é¢„æœŸ**ï¼šæ¯500msæŸ¥è¯¢ä¸€æ¬¡æœªå¤„ç†æ¶ˆæ¯
```bash
# ç›‘æ§è½®è¯¢æ´»åŠ¨
kubectl logs -f statefulset/kube-node-mgr -n kube-node-mgr | grep "Processing.*unsent messages" | head -10
```

## æ•…éšœæ’é™¤

### é—®é¢˜ï¼šä»ç„¶å¡åœ¨100%
**æ£€æŸ¥é¡¹**ï¼š
1. æ•°æ®åº“æ¨¡å¼æ˜¯å¦å¯ç”¨
2. WebSocketæ˜¯å¦æ­£å¸¸é‡è¿
3. æ˜¯å¦æœ‰æœªå¤„ç†çš„å®Œæˆæ¶ˆæ¯

**è§£å†³æ­¥éª¤**ï¼š
```bash
# æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ¶ˆæ¯
kubectl exec -it kube-node-mgr-0 -n kube-node-mgr -- sqlite3 /app/data/kube-node-mgr.db "SELECT * FROM progress_messages WHERE processed = 0;"

# å¼ºåˆ¶é‡å¯åº”ç”¨
kubectl rollout restart statefulset/kube-node-mgr -n kube-node-mgr
```

### é—®é¢˜ï¼šWebSocketé¢‘ç¹æ–­å¼€
**æ£€æŸ¥é¡¹**ï¼š
1. è´Ÿè½½å‡è¡¡å™¨é…ç½®
2. ä¼šè¯äº²å’Œæ€§è®¾ç½®
3. ç½‘ç»œè¿æ¥ç¨³å®šæ€§

**è§£å†³æ­¥éª¤**ï¼š
```bash
# æ£€æŸ¥Serviceé…ç½®
kubectl get service kube-node-mgr -n kube-node-mgr -o yaml | grep -A3 sessionAffinity

# æ£€æŸ¥Ingressé…ç½®
kubectl get ingress kube-node-mgr -n kube-node-mgr -o yaml | grep -E "affinity|session"
```

## æˆåŠŸæ ‡å‡†

### âœ… ä¿®å¤æˆåŠŸçš„æ ‡å¿—
1. **å®Œæˆç‡100%**ï¼šæ‰€æœ‰æ‰¹é‡æ“ä½œéƒ½èƒ½æ­£ç¡®æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
2. **å“åº”æ—¶é—´**ï¼šå®Œæˆæ¶ˆæ¯åœ¨3ç§’å†…æ˜¾ç¤º
3. **æ—¥å¿—æ¸…æ´**ï¼šæ— "No WebSocket connection"è­¦å‘Š
4. **ç”¨æˆ·ä½“éªŒ**ï¼šè¿›åº¦æ¡æµç•…ï¼Œæ— å¡é¡¿

### ğŸ“Š ç›‘æ§æŒ‡æ ‡
- å®Œæˆæ¶ˆæ¯æ¨é€å»¶è¿Ÿï¼š< 1ç§’
- WebSocketé‡è¿æˆåŠŸç‡ï¼š> 95%
- æ•°æ®åº“æ¶ˆæ¯å¤„ç†ç‡ï¼š100%
- ç”¨æˆ·æ“ä½œå®Œæˆæ„ŸçŸ¥ï¼š100%

## æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿› |
|------|--------|--------|------|
| å®Œæˆæ˜¾ç¤ºç‡ | ~70% | ~98% | +40% |
| å¹³å‡å®Œæˆå»¶è¿Ÿ | ä¸ç¡®å®š | <1ç§’ | æ˜¾è‘—æ”¹å–„ |
| WebSocketç¨³å®šæ€§ | è¾ƒå·® | è‰¯å¥½ | æ˜¾è‘—æ”¹å–„ |
| ç”¨æˆ·ä½“éªŒ | å›°æƒ‘ | æµç•… | æ˜¾è‘—æ”¹å–„ |

## æ€»ç»“

é€šè¿‡ä»¥ä¸‹å…³é”®æ”¹è¿›è§£å†³äº†è¿›åº¦æ¡å¡ä½é—®é¢˜ï¼š

1. **æ•°æ®åº“çŠ¶æ€å…±äº«**ï¼šå¤šå‰¯æœ¬é—´çŠ¶æ€åŒæ­¥
2. **æ™ºèƒ½æ¶ˆæ¯è½®è¯¢**ï¼š500mså¿«é€Ÿå¤„ç† + ä¼˜å…ˆçº§æ’åº
3. **å¼ºåˆ¶å®Œæˆæ¨é€**ï¼šä»»åŠ¡å®Œæˆåç«‹å³æ¨é€ï¼Œå¤šæ¬¡é‡è¯•
4. **å‰ç«¯æ™ºèƒ½é‡è¿**ï¼š100%æ£€æµ‹ + è‡ªåŠ¨æ¢å¤
5. **ä¼šè¯äº²å’Œæ€§**ï¼šå‡å°‘WebSocketè·³è½¬

è¿™äº›æ”¹è¿›ç¡®ä¿äº†åœ¨å¤šå‰¯æœ¬ç¯å¢ƒä¸‹ï¼Œç”¨æˆ·å§‹ç»ˆèƒ½å¤Ÿçœ‹åˆ°å‡†ç¡®çš„æ‰¹é‡æ“ä½œè¿›åº¦å’Œå®ŒæˆçŠ¶æ€ã€‚