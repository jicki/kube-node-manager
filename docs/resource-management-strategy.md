# Kubernetes èµ„æºç®¡ç†ç­–ç•¥

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† Kube Node Manager å¦‚ä½•ç®¡ç†ä¸åŒç±»å‹çš„ Kubernetes èµ„æºï¼Œä»¥åŠä¸ºä½•é‡‡ç”¨ä¸åŒçš„ç­–ç•¥ã€‚

## èµ„æºåˆ†ç±»

### 1. èŠ‚ç‚¹èµ„æºï¼ˆNodesï¼‰

#### ç­–ç•¥ï¼šâœ… Informer + SmartCacheï¼ˆå®æ—¶åŒæ­¥ï¼‰

#### ç‰¹ç‚¹
- **å˜åŒ–é¢‘ç‡**ï¼šä½ï¼ˆèŠ‚ç‚¹å¾ˆå°‘è¢«æ·»åŠ æˆ–åˆ é™¤ï¼‰
- **æ•°é‡è§„æ¨¡**ï¼šæœ‰é™ï¼ˆé€šå¸¸ 10-1000 ä¸ªèŠ‚ç‚¹ï¼‰
- **æ•°æ®å¤§å°**ï¼šä¸­ç­‰ï¼ˆæ¯ä¸ªèŠ‚ç‚¹ 10-20KBï¼‰
- **æŸ¥è¯¢é¢‘ç‡**ï¼šé«˜ï¼ˆç”¨æˆ·é¢‘ç¹æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨å’Œè¯¦æƒ…ï¼‰
- **å®æ—¶æ€§è¦æ±‚**ï¼šé«˜ï¼ˆéœ€è¦å®æ—¶çœ‹åˆ°çŠ¶æ€å˜åŒ–ï¼‰

#### å®ç°æ–¹å¼

```go
// 1. Informer å®æ—¶ç›‘å¬
informer.StartInformer(clusterName, clientset)

// 2. SmartCache å­˜å‚¨æ•°æ®
smartCache.SetNode(clusterName, node)

// 3. æŸ¥è¯¢ä»ç¼“å­˜è·å–
k8sNode, found := smartCache.GetNode(clusterName, nodeName)
if found {
    nodeInfo := s.nodeToNodeInfo(k8sNode)
    return nodeInfo // < 10ms å“åº”
}
```

#### ä¼˜åŠ¿
- âœ… æŸ¥è¯¢å“åº”æ—¶é—´ï¼š< 10ms
- âœ… å‡å°‘ K8s API è°ƒç”¨ï¼š99%
- âœ… å®æ—¶åŒæ­¥ï¼š1-2 ç§’å»¶è¿Ÿ
- âœ… é™ä½ API Server å‹åŠ›
- âœ… WebSocket å®æ—¶æ¨é€å˜åŒ–

#### ç›‘å¬çš„å±æ€§
- **Schedulableï¼ˆè°ƒåº¦çŠ¶æ€ï¼‰** - ç¦æ­¢/è§£é™¤è°ƒåº¦
- **Labelsï¼ˆæ ‡ç­¾ï¼‰** - èŠ‚ç‚¹æ ‡ç­¾å˜åŒ–
- **Taintsï¼ˆæ±¡ç‚¹ï¼‰** - æ±¡ç‚¹å˜åŒ–
- **Conditionsï¼ˆæ¡ä»¶ï¼‰** - èŠ‚ç‚¹å¥åº·çŠ¶æ€
- **Statusï¼ˆçŠ¶æ€ï¼‰** - Ready/NotReady
- **Resourceï¼ˆèµ„æºï¼‰** - CPU/å†…å­˜å®¹é‡ï¼ˆè¾ƒå°‘å˜åŒ–ï¼‰

#### å†…å­˜å ç”¨
- æ¯ä¸ªèŠ‚ç‚¹ï¼šçº¦ 10-20KB
- 100 ä¸ªèŠ‚ç‚¹ï¼šçº¦ 1-2MB
- 1000 ä¸ªèŠ‚ç‚¹ï¼šçº¦ 10-20MB
- **å®Œå…¨å¯æ¥å—** âœ…

---

### 2. Pod èµ„æºï¼ˆPodsï¼‰

#### ç­–ç•¥ï¼šâŒ ä¸ä½¿ç”¨ Informerï¼Œç›´æ¥ API æŸ¥è¯¢

#### ç‰¹ç‚¹
- **å˜åŒ–é¢‘ç‡**ï¼šæé«˜ï¼ˆPod é¢‘ç¹åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°ï¼‰
- **æ•°é‡è§„æ¨¡**ï¼šå·¨å¤§ï¼ˆå¯èƒ½æˆåƒä¸Šä¸‡ä¸ªï¼‰
- **æ•°æ®å¤§å°**ï¼šå¤§ï¼ˆæ¯ä¸ª Pod åŒ…å«å¾ˆå¤šä¿¡æ¯ï¼‰
- **æŸ¥è¯¢é¢‘ç‡**ï¼šä¸­ï¼ˆä»…åœ¨ç‰¹å®šæ“ä½œæ—¶æŸ¥è¯¢ï¼‰
- **å®æ—¶æ€§è¦æ±‚**ï¼šä¸­ï¼ˆä¸éœ€è¦æŒç»­ç›‘æ§æ‰€æœ‰ Podï¼‰

#### ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ Informerï¼Ÿ

1. **å†…å­˜å‹åŠ›å¤§**
   ```
   1000 ä¸ª Pod Ã— 50KB = 50MB
   10000 ä¸ª Pod Ã— 50KB = 500MB
   åœ¨å¤§é›†ç¾¤ä¸­ä¸å¯æ¥å—
   ```

2. **å˜åŒ–å¤ªé¢‘ç¹**
   - Pod æ¯ç§’å¯èƒ½åˆ›å»º/åˆ é™¤æ•°åä¸ª
   - Informer ä¼šäº§ç”Ÿå¤§é‡äº‹ä»¶
   - ç¼“å­˜æ›´æ–°å‹åŠ›å¤§

3. **æŸ¥è¯¢åœºæ™¯æœ‰é™**
   - ä¸»è¦ç”¨äºç»Ÿè®¡èŠ‚ç‚¹ä¸Šçš„ Pod æ•°é‡
   - ä»…åœ¨é©±é€æ“ä½œæ—¶éœ€è¦ Pod åˆ—è¡¨
   - ä¸éœ€è¦æŒç»­ç›‘æ§æ‰€æœ‰ Pod

#### å®ç°æ–¹å¼

```go
// ç›´æ¥è°ƒç”¨ K8s APIï¼Œä¸ä½¿ç”¨ç¼“å­˜
func (s *Service) getNodesPodCounts(clusterName string) map[string]int {
    ctx, cancel := context.WithTimeout(context.Background(), 15*time.Second)
    defer cancel()
    
    // ç›´æ¥æŸ¥è¯¢æ‰€æœ‰ Pod
    podList, err := client.CoreV1().Pods("").List(ctx, metav1.ListOptions{})
    
    // ç»Ÿè®¡æ¯ä¸ªèŠ‚ç‚¹çš„ Pod æ•°é‡
    for _, pod := range podList.Items {
        if pod.Status.Phase != corev1.PodSucceeded && 
           pod.Status.Phase != corev1.PodFailed {
            podCounts[pod.Spec.NodeName]++
        }
    }
    
    return podCounts
}
```

#### ä½¿ç”¨åœºæ™¯

**1. ç»Ÿè®¡èŠ‚ç‚¹ Pod æ•°é‡**
```go
// æ‰¹é‡è·å–å¤šä¸ªèŠ‚ç‚¹çš„ Pod æ•°é‡ï¼ˆç”¨äºèŠ‚ç‚¹åˆ—è¡¨å±•ç¤ºï¼‰
podCounts := s.getNodesPodCounts(clusterName, nodeNames)
```

**2. é©±é€èŠ‚ç‚¹å‰è·å– Pod åˆ—è¡¨**
```go
// è·å–èŠ‚ç‚¹ä¸Šéœ€è¦é©±é€çš„ Pod
func (s *Service) DrainNode(clusterName, nodeName string) error {
    // ç›´æ¥æŸ¥è¯¢èŠ‚ç‚¹ä¸Šçš„ Pod
    podList, err := client.CoreV1().Pods("").List(ctx, metav1.ListOptions{
        FieldSelector: fields.SelectorFromSet(fields.Set{
            "spec.nodeName": nodeName,
        }).String(),
    })
    
    // é©±é€ Pod
    for _, pod := range podList.Items {
        s.evictPod(ctx, client, &pod)
    }
}
```

#### ä¼˜åŠ¿
- âœ… å†…å­˜å ç”¨ä½ï¼ˆä¸ç¼“å­˜ Pod æ•°æ®ï¼‰
- âœ… æ•°æ®å§‹ç»ˆæœ€æ–°ï¼ˆå®æ—¶æŸ¥è¯¢ï¼‰
- âœ… å®ç°ç®€å•ï¼ˆæ— éœ€å¤æ‚çš„ç¼“å­˜ç®¡ç†ï¼‰

#### æ€§èƒ½ä¼˜åŒ–
è™½ç„¶ç›´æ¥æŸ¥è¯¢ APIï¼Œä½†é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¼˜åŒ–ï¼š
- âœ… ä½¿ç”¨ FieldSelector è¿‡æ»¤ï¼ˆåªæŸ¥è¯¢ç‰¹å®šèŠ‚ç‚¹çš„ Podï¼‰
- âœ… æ‰¹é‡æŸ¥è¯¢ï¼ˆä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰éœ€è¦çš„æ•°æ®ï¼‰
- âœ… è¶…æ—¶æ§åˆ¶ï¼ˆé¿å…é•¿æ—¶é—´ç­‰å¾…ï¼‰

---

### 3. Deployment èµ„æº

#### ç­–ç•¥ï¼šğŸ“‹ æ ¹æ®éœ€æ±‚é€‰æ‹©

#### å½“å‰çŠ¶æ€
- æœ¬é¡¹ç›®ä¸»è¦å…³æ³¨èŠ‚ç‚¹ç®¡ç†
- ä¸æ¶‰åŠ Deployment çš„ç®¡ç†

#### å¦‚æœæœªæ¥éœ€è¦

**åœºæ™¯ Aï¼šå®æ—¶ç›‘æ§ Deployment çŠ¶æ€**
- ä½¿ç”¨ Informer + ç¼“å­˜
- ç±»ä¼¼èŠ‚ç‚¹çš„å®ç°

**åœºæ™¯ Bï¼šå¶å°”æŸ¥è¯¢ Deployment åˆ—è¡¨**
- ç›´æ¥ API è°ƒç”¨
- ç±»ä¼¼ Pod çš„å®ç°

---

### 4. Service / ConfigMap / Secret ç­‰èµ„æº

#### ç­–ç•¥ï¼šğŸ“‹ æ ¹æ®éœ€æ±‚é€‰æ‹©

#### æ¨èç­–ç•¥

| èµ„æºç±»å‹ | å˜åŒ–é¢‘ç‡ | æ•°é‡ | æ¨èç­–ç•¥ |
|---------|---------|------|---------|
| Services | ä½ | ä¸­ | Informerï¼ˆå¦‚éœ€å®æ—¶ç›‘æ§ï¼‰ |
| ConfigMaps | ä½ | ä¸­ | ç›´æ¥ APIï¼ˆæŒ‰éœ€æŸ¥è¯¢ï¼‰ |
| Secrets | ä½ | ä¸­ | ç›´æ¥ APIï¼ˆå®‰å…¨è€ƒè™‘ï¼‰ |
| PersistentVolumes | ä½ | å° | Informer |
| PersistentVolumeClaims | ä¸­ | ä¸­ | Informer |
| Namespaces | æä½ | å° | Informer |
| Events | æé«˜ | å·¨å¤§ | ç›´æ¥ APIï¼ˆä»…æŸ¥è¯¢è¿‘æœŸï¼‰ |

---

## å†³ç­–æ ‘

```
éœ€è¦ç®¡ç†æŸä¸ª K8s èµ„æºï¼Ÿ
    â†“
è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å˜åŒ–é¢‘ç‡æ˜¯å¦ä½ï¼Ÿ                   â”‚
â”‚    (èŠ‚ç‚¹ã€Serviceã€Namespace ç­‰)     â”‚
â”‚    â†“ æ˜¯                              â”‚
â”‚ 2. æ•°é‡è§„æ¨¡æ˜¯å¦å¯æ§ï¼Ÿ                 â”‚
â”‚    (< 10000 ä¸ª)                     â”‚
â”‚    â†“ æ˜¯                              â”‚
â”‚ 3. éœ€è¦å®æ—¶ç›‘æ§çŠ¶æ€å˜åŒ–ï¼Ÿ             â”‚
â”‚    â†“ æ˜¯                              â”‚
â”‚ 4. æŸ¥è¯¢é¢‘ç‡æ˜¯å¦é«˜ï¼Ÿ                   â”‚
â”‚    â†“ æ˜¯                              â”‚
â”‚                                     â”‚
â”‚ âœ… ä½¿ç”¨ Informer + ç¼“å­˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ å¦ï¼ˆä»»ä½•ä¸€é¡¹ï¼‰
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ ä½¿ç”¨ç›´æ¥ API æŸ¥è¯¢                 â”‚
â”‚                                     â”‚
â”‚ é€‚ç”¨äºï¼š                             â”‚
â”‚ - é«˜å˜åŒ–é¢‘ç‡èµ„æºï¼ˆPodã€Eventï¼‰        â”‚
â”‚ - å¤§è§„æ¨¡èµ„æºï¼ˆæˆåƒä¸Šä¸‡ä¸ªï¼‰            â”‚
â”‚ - ä½æŸ¥è¯¢é¢‘ç‡åœºæ™¯                     â”‚
â”‚ - å®‰å…¨æ•æ„Ÿèµ„æºï¼ˆSecretï¼‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ€§èƒ½å¯¹æ¯”

### èŠ‚ç‚¹æŸ¥è¯¢ï¼ˆä½¿ç”¨ Informerï¼‰

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å“åº”æ—¶é—´ | < 10ms |
| API è°ƒç”¨ | 0 æ¬¡/æŸ¥è¯¢ |
| å†…å­˜å ç”¨ | 1-20MB |
| å®æ—¶æ€§ | 1-2 ç§’ |
| CPU å ç”¨ | æä½ |

### Pod æŸ¥è¯¢ï¼ˆç›´æ¥ APIï¼‰

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å“åº”æ—¶é—´ | 100-500ms |
| API è°ƒç”¨ | 1 æ¬¡/æŸ¥è¯¢ |
| å†…å­˜å ç”¨ | 0ï¼ˆä¸ç¼“å­˜ï¼‰ |
| å®æ—¶æ€§ | å³æ—¶ |
| CPU å ç”¨ | ä½ |

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ Informer çš„æœ€ä½³å®è·µ

**åˆå§‹åŒ–æ•°æ®**
```go
// åœ¨å¯åŠ¨ Informer å‰ï¼Œç«‹å³è·å–åˆå§‹æ•°æ®
nodeList, err := clientset.CoreV1().Nodes().List(ctx, metav1.ListOptions{})
for i := range nodeList.Items {
    smartCache.SetNode(clusterName, &nodeList.Items[i])
}

// ç„¶åå¯åŠ¨ Informer
informerSvc.StartInformer(clusterName, clientset)
```

**äº‹ä»¶è¿‡æ»¤**
```go
// åªå¤„ç†æœ‰æ„ä¹‰çš„å˜åŒ–
func hasSignificantChanges(oldNode, newNode *corev1.Node) bool {
    if oldNode.Spec.Unschedulable != newNode.Spec.Unschedulable {
        return true // è°ƒåº¦çŠ¶æ€å˜åŒ–
    }
    if !reflect.DeepEqual(oldNode.Labels, newNode.Labels) {
        return true // æ ‡ç­¾å˜åŒ–
    }
    // ... å…¶ä»–å…³é”®å±æ€§
    return false
}
```

**èµ„æºæ¸…ç†**
```go
// é›†ç¾¤åˆ é™¤æ—¶ï¼Œåœæ­¢ Informer å¹¶æ¸…ç†ç¼“å­˜
func (m *Manager) UnregisterCluster(clusterName string) {
    m.informerSvc.StopInformer(clusterName)
    m.smartCache.InvalidateCluster(clusterName)
}
```

### 2. ç›´æ¥ API æŸ¥è¯¢çš„æœ€ä½³å®è·µ

**è¶…æ—¶æ§åˆ¶**
```go
ctx, cancel := context.WithTimeout(context.Background(), 15*time.Second)
defer cancel()

podList, err := client.CoreV1().Pods("").List(ctx, metav1.ListOptions{})
```

**å­—æ®µè¿‡æ»¤**
```go
// åªæŸ¥è¯¢ç‰¹å®šèŠ‚ç‚¹çš„ Pod
podList, err := client.CoreV1().Pods("").List(ctx, metav1.ListOptions{
    FieldSelector: fields.SelectorFromSet(fields.Set{
        "spec.nodeName": nodeName,
    }).String(),
})
```

**é”™è¯¯å¤„ç†**
```go
if err != nil {
    if apierrors.IsNotFound(err) {
        // èµ„æºä¸å­˜åœ¨
    } else if apierrors.IsForbidden(err) {
        // æƒé™ä¸è¶³
    } else {
        // å…¶ä»–é”™è¯¯
    }
}
```

---

## ç›‘æ§å’Œæ—¥å¿—

### Informer ç›‘æ§

**å…³é”®æ—¥å¿—**
```
INFO: Informer for cluster my-cluster started and synced
INFO: Node updated: cluster=my-cluster, node=node-1, changes=[Schedulable]
INFO: SmartCache: Updated node node-1 in cluster my-cluster
```

**æ€§èƒ½æŒ‡æ ‡**
- Informer åŒæ­¥å»¶è¿Ÿ
- SmartCache å‘½ä¸­ç‡
- WebSocket è¿æ¥æ•°
- äº‹ä»¶å¤„ç†é€Ÿç‡

### API æŸ¥è¯¢ç›‘æ§

**å…³é”®æ—¥å¿—**
```
INFO: Successfully retrieved 100 pods from cluster my-cluster
WARNING: Failed to list pods for cluster my-cluster: timeout
```

**æ€§èƒ½æŒ‡æ ‡**
- API è°ƒç”¨æ¬¡æ•°
- API å“åº”æ—¶é—´
- API é”™è¯¯ç‡
- è¶…æ—¶æ¬¡æ•°

---

## æ€»ç»“

### å½“å‰å®ç°

| èµ„æº | ç­–ç•¥ | åŸå›  | çŠ¶æ€ |
|------|------|------|------|
| Nodes | Informer + Cache | ä½é¢‘å˜åŒ–ã€é«˜é¢‘æŸ¥è¯¢ã€éœ€å®æ—¶ | âœ… å·²å®ç° |
| Pods | ç›´æ¥ API | é«˜é¢‘å˜åŒ–ã€å¤§æ•°é‡ã€ä½é¢‘æŸ¥è¯¢ | âœ… å·²å®ç° |
| Deployments | - | ä¸åœ¨é¡¹ç›®èŒƒå›´ | - |
| Services | - | ä¸åœ¨é¡¹ç›®èŒƒå›´ | - |

### æ¶æ„ä¼˜åŠ¿

1. âœ… **é«˜æ€§èƒ½** - èŠ‚ç‚¹æŸ¥è¯¢ < 10ms
2. âœ… **ä½å»¶è¿Ÿ** - å®æ—¶åŒæ­¥ 1-2 ç§’
3. âœ… **ä½å¼€é”€** - å†…å­˜å ç”¨ 1-20MB
4. âœ… **å¯æ‰©å±•** - æ”¯æŒ 1000+ èŠ‚ç‚¹
5. âœ… **é«˜å¯ç”¨** - å®¹é”™æ€§å¼º
6. âœ… **å®æ—¶æ€§** - WebSocket æ¨é€

### è®¾è®¡åŸåˆ™

1. **æŒ‰éœ€é€‰æ‹©** - æ ¹æ®èµ„æºç‰¹ç‚¹é€‰æ‹©ç­–ç•¥
2. **æ€§èƒ½ä¼˜å…ˆ** - é«˜é¢‘æ“ä½œä½¿ç”¨ç¼“å­˜
3. **å†…å­˜å¯æ§** - ä¸ç¼“å­˜å¤§è§„æ¨¡åŠ¨æ€èµ„æº
4. **å®æ—¶æ€§å¹³è¡¡** - Informer æä¾› 1-2 ç§’å»¶è¿Ÿçš„å®æ—¶æ€§
5. **å®¹é”™æ€§** - å³ä½¿ Informer å¤±è´¥ä¹Ÿæœ‰é™çº§æ–¹æ¡ˆ

è¿™ä¸ªç­–ç•¥ç¡®ä¿äº†ç³»ç»Ÿåœ¨æ€§èƒ½ã€å®æ—¶æ€§å’Œèµ„æºå ç”¨ä¹‹é—´è¾¾åˆ°æœ€ä½³å¹³è¡¡ï¼ğŸ¯

