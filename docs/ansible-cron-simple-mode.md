# Ansible 定时任务 - 简单模式实现

## 实现日期
2025-10-31

## 功能概述

为定时任务添加**简单模式**，让用户无需理解复杂的 Cron 表达式语法，通过友好的图形界面即可设置定时任务。

## 功能特性

### 两种模式

1. **简单模式（推荐）**
   - 可视化选择执行频率
   - 自动生成 Cron 表达式
   - 适合大多数使用场景
   - 降低学习成本

2. **高级模式**
   - 手动输入 Cron 表达式
   - 支持复杂的定时规则
   - 保留原有功能
   - 适合高级用户

### 简单模式支持的频率

#### 1. 每分钟
- **生成表达式**: `* * * * *`
- **说明**: 每分钟执行一次
- **使用场景**: 实时监控、频繁检查

#### 2. 每小时
- **配置项**: 选择分钟（0-59）
- **生成表达式**: `{分钟} * * * *`
- **示例**: 每小时的第 15 分钟 → `15 * * * *`
- **使用场景**: 定期数据采集

#### 3. 每天
- **配置项**: 选择执行时间（时:分）
- **生成表达式**: `{分钟} {小时} * * *`
- **示例**: 每天 14:30 → `30 14 * * *`
- **使用场景**: 每日报表、定期清理

#### 4. 每周
- **配置项**: 
  - 选择星期（星期一到星期日）
  - 选择执行时间（时:分）
- **生成表达式**: `{分钟} {小时} * * {星期}`
- **示例**: 每周一 09:00 → `0 9 * * 1`
- **使用场景**: 周报、周期性维护

#### 5. 每月
- **配置项**: 
  - 选择日期（1-31）
  - 选择执行时间（时:分）
- **生成表达式**: `{分钟} {小时} {日} * *`
- **示例**: 每月 1 号 00:00 → `0 0 1 * *`
- **使用场景**: 月报、月度备份

#### 6. 自定义间隔
- **配置项**: 
  - 间隔数值（1-59）
  - 间隔单位（分钟/小时/天）
- **生成表达式**:
  - 分钟: `*/{数值} * * * *`
  - 小时: `0 */{数值} * * *`
  - 天: `0 0 */{数值} * *`
- **示例**: 
  - 每 5 分钟 → `*/5 * * * *`
  - 每 2 小时 → `0 */2 * * *`
  - 每 3 天 → `0 0 */3 * *`
- **使用场景**: 灵活的周期性任务

## 界面设计

### 模式切换

```
┌────────────────────────────────────────┐
│ ○ 简单模式    ○ 高级模式              │
└────────────────────────────────────────┘
```

### 简单模式界面

```
┌─────────────────────────────────────────────┐
│ 执行频率: [选择] ▼                          │
│           ├─ 每分钟                         │
│           ├─ 每小时                         │
│           ├─ 每天                           │
│           ├─ 每周                           │
│           ├─ 每月                           │
│           └─ 自定义间隔                     │
│                                             │
│ [根据选择显示相应的配置项]                  │
│                                             │
│ ℹ️ 生成的 Cron 表达式: */5 * * * *         │
└─────────────────────────────────────────────┘
```

### 配置项示例

#### 自定义间隔
```
间隔设置: [5] ▼ [分钟 ▼]
          数值   单位
```

#### 每天
```
执行时间: [14:30] 🕐
```

#### 每周
```
星期:     [星期一 ▼]
执行时间: [09:00] 🕐
```

#### 每月
```
日期:     [1]
执行时间: [00:00] 🕐
```

## 技术实现

### 前端实现

**文件**: `frontend/src/views/ansible/ScheduleManage.vue`

#### 1. 数据结构

```javascript
// Cron 模式
const cronMode = ref('simple')  // 'simple' 或 'advanced'

// 简单模式数据
const cronSimple = reactive({
  type: 'interval',           // 频率类型
  intervalValue: 5,           // 间隔数值
  intervalUnit: 'minute',     // 间隔单位
  minute: 0,                  // 小时的分钟数
  time: null,                 // 时间选择器的值
  weekday: 1,                 // 星期（0-6）
  dayOfMonth: 1               // 月份中的日期（1-31）
})
```

#### 2. Cron 表达式生成逻辑

```javascript
const updateCronFromSimple = () => {
  let cron = ''
  
  switch (cronSimple.type) {
    case 'everyMinute':
      cron = '* * * * *'
      break
      
    case 'everyHour':
      cron = `${cronSimple.minute} * * * *`
      break
      
    case 'everyDay':
      if (cronSimple.time) {
        const hour = cronSimple.time.getHours()
        const minute = cronSimple.time.getMinutes()
        cron = `${minute} ${hour} * * *`
      } else {
        cron = '0 0 * * *'
      }
      break
      
    case 'everyWeek':
      if (cronSimple.time) {
        const hour = cronSimple.time.getHours()
        const minute = cronSimple.time.getMinutes()
        cron = `${minute} ${hour} * * ${cronSimple.weekday}`
      } else {
        cron = `0 0 * * ${cronSimple.weekday}`
      }
      break
      
    case 'everyMonth':
      if (cronSimple.time) {
        const hour = cronSimple.time.getHours()
        const minute = cronSimple.time.getMinutes()
        cron = `${minute} ${hour} ${cronSimple.dayOfMonth} * *`
      } else {
        cron = `0 0 ${cronSimple.dayOfMonth} * *`
      }
      break
      
    case 'interval':
      if (cronSimple.intervalUnit === 'minute') {
        cron = `*/${cronSimple.intervalValue} * * * *`
      } else if (cronSimple.intervalUnit === 'hour') {
        cron = `0 */${cronSimple.intervalValue} * * *`
      } else if (cronSimple.intervalUnit === 'day') {
        cron = `0 0 */${cronSimple.intervalValue} * *`
      }
      break
  }
  
  scheduleForm.cron_expr = cron
}
```

#### 3. 组件使用

- **el-radio-group**: 模式切换
- **el-select**: 频率选择、单位选择、星期选择
- **el-input-number**: 数值输入
- **el-time-picker**: 时间选择
- **el-alert**: 表达式预览

### 后端兼容

后端无需修改，继续接收和验证 Cron 表达式字符串。简单模式生成的表达式与手动输入的表达式格式完全相同。

## 使用指南

### 创建定时任务（简单模式）

#### 示例 1: 每 5 分钟执行一次

```
1. 点击"创建定时任务"
2. 选择"简单模式"
3. 执行频率: 选择"自定义间隔"
4. 间隔设置: 5 分钟
5. 生成表达式: */5 * * * *
6. 填写其他信息（名称、模板、清单）
7. 点击"确定"
```

#### 示例 2: 每天凌晨 2 点执行

```
1. 点击"创建定时任务"
2. 选择"简单模式"
3. 执行频率: 选择"每天"
4. 执行时间: 02:00
5. 生成表达式: 0 2 * * *
6. 填写其他信息
7. 点击"确定"
```

#### 示例 3: 每周一上午 9 点执行

```
1. 点击"创建定时任务"
2. 选择"简单模式"
3. 执行频率: 选择"每周"
4. 星期: 星期一
5. 执行时间: 09:00
6. 生成表达式: 0 9 * * 1
7. 填写其他信息
8. 点击"确定"
```

#### 示例 4: 每月 1 号凌晨执行

```
1. 点击"创建定时任务"
2. 选择"简单模式"
3. 执行频率: 选择"每月"
4. 日期: 1
5. 执行时间: 00:00
6. 生成表达式: 0 0 1 * *
7. 填写其他信息
8. 点击"确定"
```

### 切换到高级模式

如果需要更复杂的定时规则（例如：工作日 9-17 点每小时执行），可以切换到高级模式手动输入 Cron 表达式：

```
1. 点击"高级模式"
2. 手动输入: 0 9-17 * * 1-5
3. 点击"帮助"查看语法说明
4. 填写其他信息
5. 点击"确定"
```

## Cron 表达式对照表

| 简单模式设置 | 生成的 Cron 表达式 | 说明 |
|-------------|-------------------|------|
| 每分钟 | `* * * * *` | 每分钟执行 |
| 每小时（15分） | `15 * * * *` | 每小时第15分钟 |
| 每天（14:30） | `30 14 * * *` | 每天14:30 |
| 每周（周一 09:00） | `0 9 * * 1` | 每周一09:00 |
| 每月（1号 00:00） | `0 0 1 * *` | 每月1号00:00 |
| 自定义（每5分钟） | `*/5 * * * *` | 每5分钟 |
| 自定义（每2小时） | `0 */2 * * *` | 每2小时 |
| 自定义（每3天） | `0 0 */3 * *` | 每3天 |

## 用户体验优化

### 1. 实时预览

用户选择配置后，立即显示生成的 Cron 表达式，让用户了解具体的定时规则。

### 2. 默认值

- 创建任务时默认使用简单模式
- 默认频率为"自定义间隔"，间隔 5 分钟
- 提供合理的默认时间（00:00）

### 3. 验证提示

- 日期范围验证（1-31）
- 间隔数值验证（1-59）
- 时间格式自动处理

### 4. 样式美化

```css
.cron-simple-mode {
  padding: 12px;
  background-color: #f8f9fa;
  border-radius: 4px;
  margin-top: 12px;
}
```

## 常见场景

### 1. 监控任务
- **需求**: 每 5 分钟检查服务状态
- **配置**: 自定义间隔 → 5 分钟

### 2. 数据备份
- **需求**: 每天凌晨 2 点备份数据库
- **配置**: 每天 → 02:00

### 3. 日志清理
- **需求**: 每周日凌晨清理旧日志
- **配置**: 每周 → 星期日 → 00:00

### 4. 月度报表
- **需求**: 每月 1 号上午 9 点生成报表
- **配置**: 每月 → 1 号 → 09:00

### 5. 定期检查
- **需求**: 每小时检查一次系统更新
- **配置**: 每小时 → 0 分钟

## 兼容性说明

### 与现有系统的兼容性

1. **向后兼容**: 简单模式生成的表达式与标准 Cron 表达式完全兼容
2. **数据库兼容**: 无需修改数据库结构，继续存储字符串格式的 Cron 表达式
3. **API 兼容**: 后端 API 无需修改，继续接收和验证 Cron 表达式

### 编辑现有任务

编辑已有任务时：
- 如果使用简单模式，会尝试解析现有的 Cron 表达式并回填到对应的字段
- 如果表达式过于复杂无法解析，自动切换到高级模式

## 限制和注意事项

### 1. 不支持的复杂规则

简单模式不支持以下情况，需使用高级模式：
- 多个值（例如：`0,15,30,45 * * * *` - 每小时的0、15、30、45分）
- 范围（例如：`0 9-17 * * 1-5` - 工作日9-17点）
- 组合条件
- 特殊表达式（@hourly、@daily 等）

### 2. 时区处理

- 所有时间基于服务器时区
- 执行时间显示为服务器本地时间
- 需要考虑服务器与用户所在时区的差异

### 3. 月份日期

- 每月日期选择时，如果月份没有该日期（例如 2 月 30 日），Cron 会跳过
- 建议选择 1-28 日以确保每月都能执行

## 部署

### 前端部署

```bash
cd frontend
npm run build
```

无需后端修改，只需更新前端静态文件。

### 测试

访问定时任务管理页面，验证：
- [ ] 简单模式和高级模式可以正常切换
- [ ] 各种频率类型的配置正常显示
- [ ] Cron 表达式正确生成
- [ ] 可以成功创建定时任务
- [ ] 生成的任务能够正常执行

## 总结

简单模式的添加让定时任务的配置更加友好和直观：

1. **降低学习成本**: 用户无需学习 Cron 语法
2. **减少错误**: 图形化配置避免语法错误
3. **提升效率**: 快速设置常见的定时规则
4. **保留灵活性**: 高级模式仍支持复杂场景
5. **向后兼容**: 完全兼容现有功能

这一改进将显著提升用户体验，特别是对于不熟悉 Cron 表达式的用户。

