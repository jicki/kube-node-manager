# Ansible 定时任务调度指南

## 概述

Ansible 定时任务调度功能允许您自动化重复性的运维任务，使用 Cron 表达式配置任务执行时间，支持灵活的调度策略和失败重试机制。

## 功能特性

### 核心功能

- ✅ **Cron 表达式调度**：支持标准和扩展 Cron 表达式
- ✅ **任务模板集成**：关联已有的 Ansible Playbook 模板
- ✅ **自动重试**：任务失败后自动重试（可配置）
- ✅ **灵活管理**：启用/禁用、立即执行、编辑、删除
- ✅ **执行统计**：记录执行次数和上次/下次执行时间
- ✅ **环境保护**：生产环境任务执行前二次确认

### 性能限制

- **最大活跃任务数**：100 个
- **并发执行**：最多同时执行 5 个任务
- **调度精度**：秒级（Cron 表达式支持）

## 快速开始

### 1. 创建定时任务

1. 导航到 **Ansible 任务** > **定时任务管理**
2. 点击 **创建定时任务**
3. 填写以下信息：
   - **任务名称**：唯一标识符
   - **描述**：任务说明（可选）
   - **选择模板**：选择已创建的 Playbook 模板
   - **主机清单**：选择目标主机
   - **Cron 表达式**：设置执行时间
   - **启用状态**：是否立即启用

4. 点击 **确定** 创建

### 2. Cron 表达式配置

#### 标准格式（5个字段）

```
分 时 日 月 星期
* *  *  *  *
```

#### 常用示例

```bash
# 每小时整点执行
0 * * * *

# 每天凌晨 2 点执行
0 2 * * *

# 每周一凌晨 3 点执行
0 3 * * 1

# 每月 1 号凌晨 4 点执行
0 4 1 * *

# 每 5 分钟执行一次
*/5 * * * *

# 工作日（周一到周五）每天 9 点执行
0 9 * * 1-5

# 每天 9 点到 17 点，每小时执行
0 9-17 * * *
```

#### 特殊表达式

```bash
@hourly   # 每小时执行（等同于 0 * * * *）
@daily    # 每天午夜执行（等同于 0 0 * * *）
@weekly   # 每周日午夜执行（等同于 0 0 * * 0）
@monthly  # 每月 1 号午夜执行（等同于 0 0 1 * *）
@yearly   # 每年 1 月 1 号午夜执行（等同于 0 0 1 1 *）
```

#### Cron 表达式字段说明

| 字段 | 取值范围 | 特殊字符 | 说明 |
|------|---------|---------|------|
| 分钟 | 0-59 | * , - / | 每分钟 / 列表 / 区间 / 步长 |
| 小时 | 0-23 | * , - / | 每小时 / 列表 / 区间 / 步长 |
| 日期 | 1-31 | * , - / | 每天 / 列表 / 区间 / 步长 |
| 月份 | 1-12 | * , - / | 每月 / 列表 / 区间 / 步长 |
| 星期 | 0-6 | * , - / | 每周（0=周日） |

#### 特殊字符含义

- `*` - 匹配所有值
- `,` - 列举多个值（如：1,3,5）
- `-` - 范围（如：1-5）
- `/` - 步长（如：*/5 表示每 5 个单位）

### 3. 管理定时任务

#### 启用/禁用任务

- 在任务列表中点击 **启用** 或 **禁用** 按钮
- 禁用的任务不会被调度执行
- 启用的任务立即加入调度队列

#### 立即执行任务

- 点击 **立即执行** 按钮手动触发任务
- 任务会立即创建并执行，不影响定时调度
- 仅限已启用的任务可以立即执行

#### 编辑任务

- 点击 **编辑** 按钮修改任务配置
- 修改后的任务会自动重新加载调度
- 修改 Cron 表达式会更新下次执行时间

#### 删除任务

- 点击 **删除** 按钮删除定时任务
- 删除后任务会从调度器中移除
- 已执行的任务记录不会被删除

## 高级功能

### 失败重试策略

在创建 Ansible 任务时，可以配置重试策略：

```json
{
  "retry_policy": {
    "max_retries": 3,          // 最大重试次数
    "retry_interval": 60,      // 重试间隔（秒）
    "retry_on_error": true     // 是否启用重试
  }
}
```

**重试行为**：
- 任务失败后，系统会根据配置自动重试
- 每次重试间隔会递增（exponential backoff）
- 达到最大重试次数后停止重试
- 重试过程中会记录重试次数

### 环境保护

系统支持为主机清单设置环境标签：

- **dev**（开发环境）- 默认，无限制
- **staging**（预发布环境）- 执行前提示
- **production**（生产环境）- **强制二次确认**

**生产环境保护机制**：
1. 任务提交时检测清单环境
2. 如果是生产环境，弹出确认对话框
3. 显示任务详情和风险提示
4. 用户需要勾选确认后才能执行

### 风险等级控制

模板支持设置风险等级：

- **low**（低风险）- 读取/查询操作
- **medium**（中风险）- 配置变更/重启服务
- **high**（高风险）- 删除/格式化/破坏性操作

**高风险保护机制**：
1. 执行高风险模板时弹出确认对话框
2. 显示风险警告和操作详情
3. 用户需要勾选确认后才能执行

## 使用场景

### 场景 1：定期备份

**需求**：每天凌晨 2 点备份数据库

**配置**：
- 模板：数据库备份 Playbook
- 清单：数据库服务器
- Cron 表达式：`0 2 * * *`
- 重试策略：3 次重试，间隔 5 分钟

### 场景 2：定时清理

**需求**：每小时清理临时文件

**配置**：
- 模板：清理脚本 Playbook
- 清单：应用服务器
- Cron 表达式：`0 * * * *` 或 `@hourly`
- 重试策略：不重试

### 场景 3：工作日定时巡检

**需求**：工作日每天 9 点执行系统巡检

**配置**：
- 模板：系统巡检 Playbook
- 清单：所有服务器
- Cron 表达式：`0 9 * * 1-5`
- 重试策略：2 次重试，间隔 10 分钟

### 场景 4：每 5 分钟监控

**需求**：每 5 分钟检查服务状态

**配置**：
- 模板：服务状态检查 Playbook
- 清单：监控目标
- Cron 表达式：`*/5 * * * *`
- 重试策略：不重试

## 注意事项

### 权限要求

- 所有定时任务操作需要 **admin** 权限
- 普通用户无法查看或管理定时任务

### 并发控制

- 如果定时任务执行时间重叠，后续任务会排队等待
- 系统最多同时执行 5 个任务
- 建议合理安排任务执行时间，避免高峰期重叠

### Cron 表达式验证

- 创建任务时会自动验证 Cron 表达式格式
- 无效的表达式会拒绝创建
- 可以点击 **帮助** 查看 Cron 表达式参考

### 任务数量限制

- 最多创建 100 个活跃定时任务
- 达到限制后需要禁用或删除旧任务
- 已禁用的任务不计入限制

### 时区设置

- 所有时间基于服务器时区
- 请确保服务器时区配置正确
- 可以通过 `TZ` 环境变量调整

### 执行日志

- 每次定时任务执行都会创建 Ansible Task 记录
- 可以在 **Ansible 任务** 页面查看执行日志
- 日志保留策略遵循系统配置

## 故障排查

### 任务未执行

**可能原因**：
1. 任务被禁用 - 检查任务状态
2. Cron 表达式错误 - 验证表达式格式
3. 服务未启动 - 检查调度服务状态
4. 达到并发限制 - 查看当前运行任务

**解决方法**：
- 确认任务状态为 **已启用**
- 使用在线工具验证 Cron 表达式
- 重启后端服务
- 调整任务执行时间避免冲突

### 任务执行失败

**可能原因**：
1. 模板语法错误 - 检查 Playbook 内容
2. 主机连接失败 - 验证 SSH 连接
3. 权限不足 - 检查 SSH 用户权限
4. 资源不足 - 查看系统资源

**解决方法**：
- 手动执行任务测试
- 检查任务日志定位问题
- 配置重试策略自动恢复
- 优化 Playbook 减少资源消耗

### 下次执行时间不正确

**可能原因**：
1. 时区配置错误 - 检查服务器时区
2. Cron 表达式理解错误 - 重新验证表达式
3. 系统时间不同步 - 同步系统时间

**解决方法**：
- 使用 `date` 命令检查系统时间
- 使用在线 Cron 计算器验证
- 配置 NTP 同步时间

## API 参考

### 列出定时任务

```bash
GET /api/v1/ansible/schedules?page=1&page_size=20&enabled=true
```

### 获取任务详情

```bash
GET /api/v1/ansible/schedules/:id
```

### 创建定时任务

```bash
POST /api/v1/ansible/schedules
Content-Type: application/json

{
  "name": "daily-backup",
  "description": "每日数据备份",
  "template_id": 1,
  "inventory_id": 2,
  "cluster_id": null,
  "cron_expr": "0 2 * * *",
  "extra_vars": {},
  "enabled": true
}
```

### 更新定时任务

```bash
PUT /api/v1/ansible/schedules/:id
Content-Type: application/json

{
  "name": "daily-backup",
  "cron_expr": "0 3 * * *",
  "enabled": true
}
```

### 删除定时任务

```bash
DELETE /api/v1/ansible/schedules/:id
```

### 启用/禁用任务

```bash
POST /api/v1/ansible/schedules/:id/toggle
Content-Type: application/json

{
  "enabled": true
}
```

### 立即执行任务

```bash
POST /api/v1/ansible/schedules/:id/run-now
```

## 最佳实践

### 1. 任务命名规范

使用清晰的命名，包含：
- 任务类型（backup, cleanup, monitor）
- 执行频率（daily, hourly）
- 目标对象（db, app, system）

示例：`backup-db-daily`, `cleanup-logs-hourly`

### 2. 错开高峰时段

- 避免所有任务集中在整点执行
- 使用不同的分钟数（如 5, 15, 25, 35）
- 资源密集型任务安排在低峰时段

### 3. 合理配置重试

- 网络不稳定：启用重试，间隔 1-5 分钟
- 幂等操作：可以启用重试
- 破坏性操作：不建议自动重试

### 4. 监控和告警

- 定期检查任务执行状态
- 设置失败告警通知
- 记录执行统计便于分析

### 5. 渐进式部署

- 新任务先在开发环境测试
- 使用预发布环境验证
- 确认无误后部署到生产环境

## 相关文档

- [Ansible 任务中心实施总结](./ansible-task-center-implementation.md)
- [Ansible 快速参考](./ansible-quick-reference.md)
- [环境保护和权限管理](./ansible-security-and-deployment-update.md)

## 更新日志

### v2.19.0 (2025-10-31)

- ✅ 首次发布定时任务调度功能
- ✅ 支持 Cron 表达式调度
- ✅ 集成失败重试机制
- ✅ 环境保护和风险控制
- ✅ 前端管理界面


