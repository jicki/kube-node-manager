# é£ä¹¦æœºå™¨äººä¼šè¯ç®¡ç†åŠŸèƒ½è¯´æ˜

## ğŸ¯ æ–°åŠŸèƒ½æ¦‚è¿°

å®ç°äº†ç”¨æˆ·ä¼šè¯ç®¡ç†æœºåˆ¶ï¼Œç®€åŒ–äº†èŠ‚ç‚¹æ“ä½œæµç¨‹ï¼š

### ä¹‹å‰çš„æ–¹å¼ âŒ
```
/node list test-k8s-cluster
/node info test-k8s-cluster node-1
/node cordon test-k8s-cluster node-1
```
æ¯æ¬¡éƒ½éœ€è¦æŒ‡å®šé›†ç¾¤åç§°

### ç°åœ¨çš„æ–¹å¼ âœ…
```
/node list              # æŸ¥çœ‹æ‰€æœ‰é›†ç¾¤
/node set test-k8s-cluster  # åˆ‡æ¢åˆ°é›†ç¾¤
/node nodes             # æŸ¥çœ‹èŠ‚ç‚¹
/node info node-1       # æŸ¥çœ‹èŠ‚ç‚¹è¯¦æƒ…
/node cordon node-1     # ç¦æ­¢è°ƒåº¦
```
åªéœ€é€‰æ‹©ä¸€æ¬¡é›†ç¾¤ï¼Œåç»­æ“ä½œè‡ªåŠ¨ä½¿ç”¨è¯¥é›†ç¾¤

## ğŸ“ å‘½ä»¤å˜æ›´

### 1. `/node list` - æ˜¾ç¤ºé›†ç¾¤åˆ—è¡¨

**ä¹‹å‰**ï¼šæ˜¾ç¤ºèŠ‚ç‚¹åˆ—è¡¨  
**ç°åœ¨**ï¼šæ˜¾ç¤ºæ‰€æœ‰å¯ç”¨é›†ç¾¤åˆ—è¡¨

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
ğŸ“‹ é›†ç¾¤åˆ—è¡¨

é›†ç¾¤æ•°é‡: 2

ğŸ“¦ default
çŠ¶æ€: å¥åº· | èŠ‚ç‚¹æ•°: 2
ğŸ’¡ ä½¿ç”¨å‘½ä»¤åˆ‡æ¢: /node set default

ğŸ“¦ test-k8s-cluster
çŠ¶æ€: å¥åº· | èŠ‚ç‚¹æ•°: 2
ğŸ’¡ ä½¿ç”¨å‘½ä»¤åˆ‡æ¢: /node set test-k8s-cluster

ğŸ’¡ ä½¿ç”¨ /node set <é›†ç¾¤å> åˆ‡æ¢åˆ°æŒ‡å®šé›†ç¾¤åï¼Œå³å¯è¿›è¡ŒèŠ‚ç‚¹æ“ä½œ
```

### 2. `/node set <é›†ç¾¤å>` - æ–°å¢å‘½ä»¤

åˆ‡æ¢åˆ°æŒ‡å®šé›†ç¾¤ï¼Œè®¾ç½®ä¸ºå½“å‰æ“ä½œçš„é›†ç¾¤ã€‚

**ç”¨æ³•**ï¼š
```
/node set default
/node set test-k8s-cluster
```

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
âœ… å·²åˆ‡æ¢åˆ°é›†ç¾¤: test-k8s-cluster

ç°åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤:
â€¢ /node nodes - æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨
â€¢ /node info <èŠ‚ç‚¹å> - æŸ¥çœ‹èŠ‚ç‚¹è¯¦æƒ…
â€¢ /node cordon <èŠ‚ç‚¹å> - ç¦æ­¢è°ƒåº¦
â€¢ /node uncordon <èŠ‚ç‚¹å> - æ¢å¤è°ƒåº¦
```

### 3. `/node nodes` - æ–°å¢å‘½ä»¤

æŸ¥çœ‹å½“å‰é€‰æ‹©çš„é›†ç¾¤çš„èŠ‚ç‚¹åˆ—è¡¨ã€‚

**ç”¨æ³•**ï¼š
```
/node nodes
```

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
ğŸ“‹ èŠ‚ç‚¹åˆ—è¡¨

é›†ç¾¤: test-k8s-cluster
èŠ‚ç‚¹æ•°é‡: 2

node-1
çŠ¶æ€: ğŸŸ¢ Ready | è°ƒåº¦: âœ… å¯è°ƒåº¦

node-2
çŠ¶æ€: ğŸŸ¢ Ready | è°ƒåº¦: â›” ç¦æ­¢è°ƒåº¦
```

### 4. `/node info <èŠ‚ç‚¹å>` - ç®€åŒ–å‚æ•°

**ä¹‹å‰**ï¼š`/node info <é›†ç¾¤å> <èŠ‚ç‚¹å>`  
**ç°åœ¨**ï¼š`/node info <èŠ‚ç‚¹å>`

è‡ªåŠ¨ä½¿ç”¨å½“å‰é€‰æ‹©çš„é›†ç¾¤ã€‚

**ç”¨æ³•**ï¼š
```
/node info node-1
```

### 5. `/node cordon <èŠ‚ç‚¹å> [åŸå› ]` - ç®€åŒ–å‚æ•°

**ä¹‹å‰**ï¼š`/node cordon <é›†ç¾¤å> <èŠ‚ç‚¹å> [åŸå› ]`  
**ç°åœ¨**ï¼š`/node cordon <èŠ‚ç‚¹å> [åŸå› ]`

**ç”¨æ³•**ï¼š
```
/node cordon node-1
/node cordon node-1 ç»´æŠ¤å‡çº§
```

### 6. `/node uncordon <èŠ‚ç‚¹å>` - ç®€åŒ–å‚æ•°

**ä¹‹å‰**ï¼š`/node uncordon <é›†ç¾¤å> <èŠ‚ç‚¹å>`  
**ç°åœ¨**ï¼š`/node uncordon <èŠ‚ç‚¹å>`

**ç”¨æ³•**ï¼š
```
/node uncordon node-1
```

## ğŸš€ ä½¿ç”¨æµç¨‹

### æ­¥éª¤ 1ï¼šæŸ¥çœ‹å¯ç”¨é›†ç¾¤

```
/node list
```

### æ­¥éª¤ 2ï¼šé€‰æ‹©è¦æ“ä½œçš„é›†ç¾¤

```
/node set test-k8s-cluster
```

### æ­¥éª¤ 3ï¼šæŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨

```
/node nodes
```

### æ­¥éª¤ 4ï¼šè¿›è¡ŒèŠ‚ç‚¹æ“ä½œ

```
/node info node-1
/node cordon node-1
/node uncordon node-1
```

## ğŸ’¾ æŠ€æœ¯å®ç°

### æ•°æ®åº“è¡¨

æ–°å¢ `feishu_user_sessions` è¡¨ï¼Œå­˜å‚¨ç”¨æˆ·çš„ä¼šè¯çŠ¶æ€ï¼š

```sql
CREATE TABLE feishu_user_sessions (
    id SERIAL PRIMARY KEY,
    feishu_user_id VARCHAR(255) UNIQUE NOT NULL,
    current_cluster VARCHAR(255),
    last_command_time TIMESTAMP,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    deleted_at TIMESTAMP
);
```

### ä¼šè¯ç®¡ç†æ–¹æ³•

- `GetOrCreateUserSession(feishuUserID)` - è·å–æˆ–åˆ›å»ºç”¨æˆ·ä¼šè¯
- `SetCurrentCluster(feishuUserID, clusterName)` - è®¾ç½®å½“å‰é›†ç¾¤
- `GetCurrentCluster(feishuUserID)` - è·å–å½“å‰é›†ç¾¤

### è‡ªåŠ¨ä¼šè¯ç®¡ç†

- æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„ä¼šè¯çŠ¶æ€
- ä¼šè¯çŠ¶æ€æŒä¹…åŒ–åœ¨æ•°æ®åº“ä¸­
- åˆ‡æ¢é›†ç¾¤åï¼Œæ‰€æœ‰åç»­å‘½ä»¤è‡ªåŠ¨ä½¿ç”¨è¯¥é›†ç¾¤
- å¦‚æœæœªé€‰æ‹©é›†ç¾¤ï¼Œä¼šæç¤ºç”¨æˆ·å…ˆé€‰æ‹©

## ğŸ”„ è¿ç§»æ•°æ®åº“

é¦–æ¬¡è¿è¡Œæ›´æ–°åçš„åº”ç”¨æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»º `feishu_user_sessions` è¡¨ã€‚

### æ‰‹åŠ¨è¿è¡Œè¿ç§»

å¦‚æœéœ€è¦æ‰‹åŠ¨è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š

```bash
cd /Users/jicki/jicki/github/kube-node-manager/backend
go run cmd/main.go
```

åº”ç”¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œæ•°æ®åº“è¿ç§»ã€‚

## ğŸ“Š ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ä¹‹å‰

ç”¨æˆ·éœ€è¦è®°ä½é›†ç¾¤åç§°ï¼Œæ¯æ¬¡æ“ä½œéƒ½è¦è¾“å…¥ï¼š
```
/node list test-k8s-cluster          # 15ç§’
/node info test-k8s-cluster node-1   # 18ç§’
/node cordon test-k8s-cluster node-1 # 20ç§’
```
**æ€»æ—¶é—´**ï¼š53ç§’ï¼Œ3æ¬¡è¾“å…¥é›†ç¾¤å

### ä¹‹å

ç”¨æˆ·åªéœ€é€‰æ‹©ä¸€æ¬¡é›†ç¾¤ï¼š
```
/node set test-k8s-cluster  # 8ç§’
/node info node-1           # 10ç§’
/node cordon node-1         # 12ç§’
```
**æ€»æ—¶é—´**ï¼š30ç§’ï¼Œ1æ¬¡è¾“å…¥é›†ç¾¤å

**æ•ˆç‡æå‡**ï¼š~43%

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¼šè¯æŒä¹…åŒ–

ç”¨æˆ·çš„é›†ç¾¤é€‰æ‹©ä¼šä¸€ç›´ä¿å­˜ï¼Œç›´åˆ°ä¸»åŠ¨åˆ‡æ¢åˆ°å…¶ä»–é›†ç¾¤ã€‚é‡å¯åº”ç”¨æˆ–é‡æ–°ç™»å½•åï¼Œä¼šè¯çŠ¶æ€ä»ç„¶ä¿ç•™ã€‚

### 2. æœªé€‰æ‹©é›†ç¾¤æ—¶çš„æç¤º

å¦‚æœç”¨æˆ·å°šæœªé€‰æ‹©é›†ç¾¤å°±æ‰§è¡ŒèŠ‚ç‚¹æ“ä½œï¼Œä¼šæ”¶åˆ°æç¤ºï¼š

```
âŒ å°šæœªé€‰æ‹©é›†ç¾¤

è¯·å…ˆä½¿ç”¨ /node list æŸ¥çœ‹é›†ç¾¤åˆ—è¡¨
ç„¶åä½¿ç”¨ /node set <é›†ç¾¤å> é€‰æ‹©é›†ç¾¤
```

### 3. å¤šç”¨æˆ·ç‹¬ç«‹ä¼šè¯

æ¯ä¸ªé£ä¹¦ç”¨æˆ·éƒ½æœ‰ç‹¬ç«‹çš„ä¼šè¯çŠ¶æ€ï¼Œä¸ä¼šäº’ç›¸å½±å“ã€‚

### 4. ä¼šè¯è¶…æ—¶

å½“å‰ç‰ˆæœ¬æ²¡æœ‰ä¼šè¯è¶…æ—¶æœºåˆ¶ï¼Œç”¨æˆ·çš„é€‰æ‹©ä¼šä¸€ç›´ä¿ç•™ã€‚æœªæ¥ç‰ˆæœ¬å¯ä»¥è€ƒè™‘æ·»åŠ è¶…æ—¶åŠŸèƒ½ï¼ˆå¦‚ 24 å°æ—¶æ— æ“ä½œåè‡ªåŠ¨æ¸…é™¤ï¼‰ã€‚

## ğŸ¨ å‘½ä»¤å¯¹ç…§è¡¨

| æ“ä½œ | æ—§å‘½ä»¤ | æ–°å‘½ä»¤ |
|-----|--------|--------|
| æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨ | `/node list <é›†ç¾¤å>` | `/node set <é›†ç¾¤å>` â†’ `/node nodes` |
| æŸ¥çœ‹èŠ‚ç‚¹è¯¦æƒ… | `/node info <é›†ç¾¤å> <èŠ‚ç‚¹å>` | `/node info <èŠ‚ç‚¹å>` |
| ç¦æ­¢è°ƒåº¦ | `/node cordon <é›†ç¾¤å> <èŠ‚ç‚¹å>` | `/node cordon <èŠ‚ç‚¹å>` |
| æ¢å¤è°ƒåº¦ | `/node uncordon <é›†ç¾¤å> <èŠ‚ç‚¹å>` | `/node uncordon <èŠ‚ç‚¹å>` |
| æŸ¥çœ‹é›†ç¾¤åˆ—è¡¨ | æ—  | `/node list` |
| é€‰æ‹©é›†ç¾¤ | æ—  | `/node set <é›†ç¾¤å>` |

## ğŸ“š ç›¸å…³æ–‡ä»¶

- **æ¨¡å‹å®šä¹‰**ï¼š`backend/internal/model/feishu.go`
- **ä¼šè¯ç®¡ç†**ï¼š`backend/internal/service/feishu/feishu.go`
- **å‘½ä»¤å¤„ç†**ï¼š`backend/internal/service/feishu/command_node.go`
- **å¡ç‰‡æ„å»º**ï¼š`backend/internal/service/feishu/card_builder.go`
- **æ•°æ®åº“è¿ç§»**ï¼š`backend/internal/model/migrate.go`

## ğŸ”§ å¼€å‘è€…è¯´æ˜

### æ·»åŠ æ–°çš„ä¼šè¯çŠ¶æ€å­—æ®µ

å¦‚æœéœ€è¦å­˜å‚¨å…¶ä»–ä¼šè¯ä¿¡æ¯ï¼ˆå¦‚å½“å‰å‘½åç©ºé—´ã€è¿‡æ»¤æ¡ä»¶ç­‰ï¼‰ï¼š

1. ä¿®æ”¹ `model.FeishuUserSession` ç»“æ„ä½“
2. æ·»åŠ å¯¹åº”çš„ getter/setter æ–¹æ³•
3. åœ¨å‘½ä»¤å¤„ç†å™¨ä¸­ä½¿ç”¨æ–°å­—æ®µ

### ç¤ºä¾‹ï¼šæ·»åŠ å½“å‰å‘½åç©ºé—´

```go
// åœ¨ model/feishu.go ä¸­
type FeishuUserSession struct {
    // ... ç°æœ‰å­—æ®µ
    CurrentNamespace string `json:"current_namespace" gorm:"type:varchar(255)"`
}

// åœ¨ service/feishu/feishu.go ä¸­
func (s *Service) SetCurrentNamespace(feishuUserID, namespace string) error {
    session, err := s.GetOrCreateUserSession(feishuUserID)
    if err != nil {
        return err
    }
    
    session.CurrentNamespace = namespace
    session.LastCommandTime = time.Now()
    
    return s.db.Save(session).Error
}
```

---

**æ›´æ–°æ—¶é—´**ï¼š2025/10/17  
**ç‰ˆæœ¬**ï¼šv2.1 - ä¼šè¯ç®¡ç†

