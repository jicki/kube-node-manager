# é£ä¹¦æœºå™¨äºº Label å’Œ Taint ç®¡ç†åŠŸèƒ½å®ç°

## ğŸ“… å®æ–½æ—¶é—´
2024-10-21

## ğŸ“Š å®æ–½ä¼˜å…ˆçº§
**é«˜ä¼˜å…ˆçº§** - ç¬¬ä¸€æ‰¹å®ç°

## âœ… å·²å®ç°åŠŸèƒ½

### 1. Label ç®¡ç†å‘½ä»¤

#### å‘½ä»¤åˆ—è¡¨
```
/label list <èŠ‚ç‚¹å>                    - æŸ¥çœ‹èŠ‚ç‚¹æ‰€æœ‰æ ‡ç­¾
/label add <èŠ‚ç‚¹å> <key>=<value>       - æ·»åŠ æ ‡ç­¾
/label remove <èŠ‚ç‚¹å> <key>            - åˆ é™¤æ ‡ç­¾
/label update <èŠ‚ç‚¹å> <key>=<value>    - æ›´æ–°æ ‡ç­¾ï¼ˆç­‰åŒäº addï¼‰
```

#### åŠŸèƒ½ç‰¹æ€§
- âœ… **æ ‡ç­¾åˆ—è¡¨æŸ¥çœ‹**: åˆ†ç±»æ˜¾ç¤ºç”¨æˆ·æ ‡ç­¾å’Œç³»ç»Ÿæ ‡ç­¾
- âœ… **å•ä¸ªæ ‡ç­¾æ·»åŠ **: æ”¯æŒ `key=value` æ ¼å¼
- âœ… **æ‰¹é‡æ ‡ç­¾æ·»åŠ **: æ”¯æŒ `key1=val1,key2=val2` æ ¼å¼
- âœ… **æ ‡ç­¾åˆ é™¤**: æ”¯æŒåˆ é™¤æŒ‡å®šçš„æ ‡ç­¾key
- âœ… **å¸®åŠ©å¡ç‰‡**: æä¾›è¯¦ç»†çš„ç”¨æ³•è¯´æ˜å’Œç¤ºä¾‹
- âœ… **é”™è¯¯å¤„ç†**: å‹å¥½çš„é”™è¯¯æç¤ºå’Œå»ºè®®

#### ä½¿ç”¨ç¤ºä¾‹

**æŸ¥çœ‹èŠ‚ç‚¹æ ‡ç­¾**
```
/label list node-1
```
è¿”å›ï¼š
- ç”¨æˆ·æ ‡ç­¾åˆ—è¡¨ï¼ˆè‡ªå®šä¹‰æ ‡ç­¾ï¼‰
- ç³»ç»Ÿæ ‡ç­¾åˆ—è¡¨ï¼ˆKubernetes ç³»ç»Ÿæ ‡ç­¾ï¼Œå‰5ä¸ªï¼‰

**æ·»åŠ å•ä¸ªæ ‡ç­¾**
```
/label add node-1 env=production
```

**æ·»åŠ å¤šä¸ªæ ‡ç­¾**
```
/label add node-1 env=prod,app=web,version=v1.0
```

**åˆ é™¤æ ‡ç­¾**
```
/label remove node-1 env
```

#### æŠ€æœ¯å®ç°

**æ–‡ä»¶ç»“æ„**
- `backend/internal/service/feishu/command_label.go` - Label å‘½ä»¤å¤„ç†å™¨
- `backend/internal/service/feishu/card_builder.go` - æ ‡ç­¾å¡ç‰‡æ„å»º
- `backend/internal/service/feishu/feishu.go` - æœåŠ¡æ¥å£å®šä¹‰
- `backend/internal/service/services.go` - æœåŠ¡é€‚é…å™¨

**æ ¸å¿ƒåŠŸèƒ½**
```go
type LabelCommandHandler struct{}

// ä¸»è¦æ–¹æ³•
- Handle()            // è·¯ç”±åˆ°å…·ä½“æ“ä½œ
- handleListLabels()  // æŸ¥çœ‹æ ‡ç­¾
- handleAddLabel()    // æ·»åŠ æ ‡ç­¾
- handleRemoveLabel() // åˆ é™¤æ ‡ç­¾
- parseLabels()       // è§£ææ ‡ç­¾å‚æ•°
```

**å¡ç‰‡ç»„ä»¶**
```go
- BuildLabelListCard()    // æ ‡ç­¾åˆ—è¡¨å¡ç‰‡ï¼ˆåˆ†ç±»æ˜¾ç¤ºï¼‰
- BuildLabelHelpCard()    // å¸®åŠ©å¡ç‰‡
```

---

### 2. Taint ç®¡ç†å‘½ä»¤

#### å‘½ä»¤åˆ—è¡¨
```
/taint list <èŠ‚ç‚¹å>                            - æŸ¥çœ‹èŠ‚ç‚¹æ±¡ç‚¹
/taint add <èŠ‚ç‚¹å> <key>=<value>:<effect>      - æ·»åŠ æ±¡ç‚¹
/taint remove <èŠ‚ç‚¹å> <key>                    - åˆ é™¤æ±¡ç‚¹
```

#### Effect ç±»å‹
| Effect | å›¾æ ‡ | è¯´æ˜ | é£é™©çº§åˆ« |
|--------|------|------|---------|
| NoSchedule | â›” | ä¸è°ƒåº¦æ–° Pod | ä½ |
| PreferNoSchedule | âš ï¸ | å°½é‡ä¸è°ƒåº¦æ–° Pod | ä½ |
| NoExecute | ğŸš« | ä¸è°ƒåº¦ä¸”é©±é€ç°æœ‰ Pod | é«˜ï¼ˆå±é™©ï¼‰ |

#### åŠŸèƒ½ç‰¹æ€§
- âœ… **æ±¡ç‚¹åˆ—è¡¨æŸ¥çœ‹**: å±•ç¤ºæ‰€æœ‰æ±¡ç‚¹åŠå…¶Effect
- âœ… **æ±¡ç‚¹æ·»åŠ **: æ”¯æŒ `key=value:effect` æ ¼å¼
- âœ… **æ±¡ç‚¹åˆ é™¤**: æ”¯æŒåˆ é™¤æŒ‡å®šçš„æ±¡ç‚¹key
- âœ… **å®‰å…¨è­¦å‘Š**: NoExecute æ“ä½œæ˜¾ç¤ºè­¦å‘Šå¡ç‰‡
- âœ… **å¸®åŠ©å¡ç‰‡**: æä¾›è¯¦ç»†çš„ç”¨æ³•è¯´æ˜å’Œ Effect ç±»å‹è¯´æ˜
- âœ… **é”™è¯¯å¤„ç†**: å‹å¥½çš„é”™è¯¯æç¤ºå’Œå»ºè®®

#### ä½¿ç”¨ç¤ºä¾‹

**æŸ¥çœ‹èŠ‚ç‚¹æ±¡ç‚¹**
```
/taint list node-1
```
è¿”å›ï¼š
- æ±¡ç‚¹åˆ—è¡¨ï¼Œæ¯ä¸ªæ±¡ç‚¹æ˜¾ç¤ºï¼š
  - Keyã€Valueã€Effect
  - Effect è¯´æ˜å’Œå›¾æ ‡
  - é¢œè‰²ç¼–ç ï¼ˆæ ¹æ®å±é™©ç¨‹åº¦ï¼‰

**æ·»åŠ æ±¡ç‚¹**
```
/taint add node-1 maintenance=true:NoSchedule
```

**åˆ é™¤æ±¡ç‚¹**
```
/taint remove node-1 maintenance
```

**NoExecute è­¦å‘Š**
å½“å°è¯•æ·»åŠ  NoExecute æ±¡ç‚¹æ—¶ï¼š
```
/taint add node-1 dedicated=gpu:NoExecute
```
è¿”å›ï¼šâš ï¸ è­¦å‘Šå¡ç‰‡ï¼Œæç¤ºæ“ä½œé£é™©å¹¶å»ºè®®é€šè¿‡ Web ç•Œé¢æ“ä½œ

#### æŠ€æœ¯å®ç°

**æ–‡ä»¶ç»“æ„**
- `backend/internal/service/feishu/command_taint.go` - Taint å‘½ä»¤å¤„ç†å™¨
- `backend/internal/service/feishu/card_builder.go` - æ±¡ç‚¹å¡ç‰‡æ„å»º

**æ ¸å¿ƒåŠŸèƒ½**
```go
type TaintCommandHandler struct{}

// ä¸»è¦æ–¹æ³•
- Handle()             // è·¯ç”±åˆ°å…·ä½“æ“ä½œ
- handleListTaints()   // æŸ¥çœ‹æ±¡ç‚¹
- handleAddTaint()     // æ·»åŠ æ±¡ç‚¹
- handleRemoveTaint()  // åˆ é™¤æ±¡ç‚¹
- parseTaints()        // è§£ææ±¡ç‚¹å‚æ•°ï¼ˆå«EffectéªŒè¯ï¼‰
```

**å¡ç‰‡ç»„ä»¶**
```go
- BuildTaintListCard()              // æ±¡ç‚¹åˆ—è¡¨å¡ç‰‡ï¼ˆå¸¦å›¾æ ‡å’Œè¯´æ˜ï¼‰
- BuildTaintHelpCard()              // å¸®åŠ©å¡ç‰‡ï¼ˆå« Effect è¯´æ˜ï¼‰
- BuildTaintNoExecuteWarningCard()  // NoExecute è­¦å‘Šå¡ç‰‡
```

**å®‰å…¨ç‰¹æ€§**
- NoExecute æ£€æµ‹ï¼šåœ¨æ·»åŠ æ±¡ç‚¹å‰æ£€æŸ¥æ˜¯å¦åŒ…å« NoExecute
- è­¦å‘Šå¡ç‰‡ï¼šæ˜¾ç¤ºå±é™©æ“ä½œæç¤º
- å»ºè®®æ›¿ä»£æ–¹æ¡ˆï¼šå¼•å¯¼ç”¨æˆ·é€šè¿‡ Web ç•Œé¢æ“ä½œ

---

### 3. é”™è¯¯å¤„ç†æ”¹è¿›

#### ç»Ÿä¸€é”™è¯¯ç»“æ„

åˆ›å»ºäº† `BotError` ç»“æ„æ¥æ ‡å‡†åŒ–é”™è¯¯å¤„ç†ï¼š

```go
type BotError struct {
    Code       string   // é”™è¯¯ç 
    Message    string   // ç”¨æˆ·å‹å¥½çš„é”™è¯¯æè¿°
    Suggestion string   // æ¢å¤å»ºè®®
    Details    string   // æŠ€æœ¯ç»†èŠ‚
}
```

#### é”™è¯¯ç å®šä¹‰

**é›†ç¾¤ç›¸å…³**
- `ERROR_CLUSTER_NOT_SELECTED` - æœªé€‰æ‹©é›†ç¾¤
- `ERROR_CLUSTER_NOT_FOUND` - é›†ç¾¤ä¸å­˜åœ¨
- `ERROR_CLUSTER_CONNECTION` - é›†ç¾¤è¿æ¥å¤±è´¥

**èŠ‚ç‚¹ç›¸å…³**
- `ERROR_NODE_NOT_FOUND` - èŠ‚ç‚¹ä¸å­˜åœ¨
- `ERROR_NODE_OPERATION` - èŠ‚ç‚¹æ“ä½œå¤±è´¥
- `ERROR_NODE_DATA_FORMAT` - èŠ‚ç‚¹æ•°æ®æ ¼å¼é”™è¯¯

**æ ‡ç­¾ç›¸å…³**
- `ERROR_LABEL_FORMAT` - æ ‡ç­¾æ ¼å¼é”™è¯¯
- `ERROR_LABEL_OPERATION` - æ ‡ç­¾æ“ä½œå¤±è´¥
- `ERROR_LABEL_VALIDATION` - æ ‡ç­¾éªŒè¯å¤±è´¥

**æ±¡ç‚¹ç›¸å…³**
- `ERROR_TAINT_FORMAT` - æ±¡ç‚¹æ ¼å¼é”™è¯¯
- `ERROR_TAINT_OPERATION` - æ±¡ç‚¹æ“ä½œå¤±è´¥
- `ERROR_TAINT_VALIDATION` - æ±¡ç‚¹éªŒè¯å¤±è´¥

**å‚æ•°ç›¸å…³**
- `ERROR_INVALID_ARGUMENT` - æ— æ•ˆå‚æ•°
- `ERROR_MISSING_ARGUMENT` - ç¼ºå°‘å‚æ•°

**æœåŠ¡ç›¸å…³**
- `ERROR_SERVICE_NOT_CONFIGURED` - æœåŠ¡æœªé…ç½®
- `ERROR_SERVICE_UNAVAILABLE` - æœåŠ¡ä¸å¯ç”¨

**æƒé™ç›¸å…³**
- `ERROR_PERMISSION_DENIED` - æƒé™ä¸è¶³
- `ERROR_NOT_AUTHENTICATED` - æœªè®¤è¯

#### å¸¸è§é”™è¯¯æ„é€ å‡½æ•°

**ç¤ºä¾‹**
```go
// æœªé€‰æ‹©é›†ç¾¤
NewClusterNotSelectedError()

// èŠ‚ç‚¹ä¸å­˜åœ¨
NewNodeNotFoundError(nodeName, clusterName)

// æœåŠ¡æœªé…ç½®
NewServiceNotConfiguredError(serviceName)

// æ— æ•ˆå‚æ•°
NewInvalidArgumentError(argName, expectedFormat, actualValue)

// ç¼ºå°‘å‚æ•°
NewMissingArgumentError(command, usage)

// æ ‡ç­¾æ ¼å¼é”™è¯¯
NewLabelFormatError(details)

// æ±¡ç‚¹æ ¼å¼é”™è¯¯
NewTaintFormatError(details)

// æ“ä½œå¤±è´¥
NewOperationFailedError(operation, resource, reason)
```

#### å¢å¼ºçš„é”™è¯¯å¡ç‰‡

**BuildEnhancedErrorCard** ç»„ä»¶åŒ…å«ï¼š
1. é”™è¯¯ç ï¼ˆä¾¿äºè¿½è¸ªï¼‰
2. ç”¨æˆ·å‹å¥½çš„é”™è¯¯æè¿°
3. ğŸ’¡ è§£å†³å»ºè®®ï¼ˆå¯æ“ä½œçš„æ­¥éª¤ï¼‰
4. æŠ€æœ¯è¯¦æƒ…ï¼ˆç”¨äºè°ƒè¯•ï¼‰

**å¡ç‰‡ç»“æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ é”™è¯¯                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é”™è¯¯: èŠ‚ç‚¹ node-1 ä¸å­˜åœ¨        â”‚
â”‚ é”™è¯¯ç : ERROR_NODE_NOT_FOUND    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¡ è§£å†³å»ºè®®                     â”‚
â”‚ â€¢ ä½¿ç”¨ /node list æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹  â”‚
â”‚ â€¢ æ£€æŸ¥èŠ‚ç‚¹åç§°æ˜¯å¦æ­£ç¡®          â”‚
â”‚ â€¢ ç¡®è®¤èŠ‚ç‚¹æ˜¯å¦å·²è¢«åˆ é™¤          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŠ€æœ¯è¯¦æƒ…: cluster=xxx, node=... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æŠ€æœ¯å®ç°

**æ–‡ä»¶ç»“æ„**
- `backend/internal/service/feishu/errors.go` - é”™è¯¯å®šä¹‰å’Œæ„é€ å‡½æ•°
- `backend/internal/service/feishu/card_builder.go` - å¢å¼ºé”™è¯¯å¡ç‰‡

**æ ¸å¿ƒä»£ç **
```go
// errors.go
type BotError struct { ... }
const ( ... ) // é”™è¯¯ç å¸¸é‡
func New...Error() *BotError { ... }

// card_builder.go
func BuildErrorCard(errorMsg string) string { ... }
func BuildEnhancedErrorCard(code, message, suggestion, details string) string { ... }
func BuildErrorCardV2(err *BotError) string { ... }
```

---

### 4. å®‰å…¨å¢å¼ºï¼ˆéƒ¨åˆ†å®ç°ï¼‰

#### NoExecute æ±¡ç‚¹å®‰å…¨æœºåˆ¶

**åœºæ™¯**: ç”¨æˆ·å°è¯•æ·»åŠ  NoExecute æ±¡ç‚¹

**å¤„ç†æµç¨‹**:
1. æ£€æµ‹å‘½ä»¤ä¸­æ˜¯å¦åŒ…å« NoExecute
2. å¦‚æœåŒ…å«ï¼Œè¿”å›è­¦å‘Šå¡ç‰‡è€Œä¸æ˜¯æ‰§è¡Œæ“ä½œ
3. è­¦å‘Šå¡ç‰‡å†…å®¹ï¼š
   - èŠ‚ç‚¹åç§°å’Œæ±¡ç‚¹è¯¦æƒ…
   - âš ï¸ å±é™©æ“ä½œè­¦å‘Š
   - å½±å“è¯´æ˜ï¼ˆé©±é€ Podã€æœåŠ¡ä¸­æ–­ï¼‰
   - å»ºè®®é€šè¿‡ Web ç•Œé¢æ“ä½œ

**ç¤ºä¾‹**
```
ç”¨æˆ·è¾“å…¥ï¼š/taint add node-1 app=db:NoExecute

è¿”å›å¡ç‰‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ å±é™©æ“ä½œç¡®è®¤               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ èŠ‚ç‚¹: node-1                  â”‚
â”‚ æ±¡ç‚¹: app=db:NoExecute        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ è­¦å‘Š                       â”‚
â”‚ NoExecute æ±¡ç‚¹ä¼šç«‹å³é©±é€èŠ‚ç‚¹  â”‚
â”‚ ä¸Šæ‰€æœ‰ä¸èƒ½å®¹å¿è¯¥æ±¡ç‚¹çš„ Podï¼Œ  â”‚
â”‚ è¿™å¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­ã€‚          â”‚
â”‚                               â”‚
â”‚ è¯·ç¡®è®¤æ‚¨äº†è§£æ­¤æ“ä½œçš„å½±å“ã€‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¡ å¦‚éœ€ç»§ç»­ï¼Œè¯·è”ç³»ç®¡ç†å‘˜     â”‚
â”‚    é€šè¿‡ Web ç•Œé¢æ“ä½œ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æœåŠ¡æ¶æ„

### æœåŠ¡é›†æˆ

**é£ä¹¦æœåŠ¡æ¥å£æ‰©å±•**
```go
// feishu.go
type LabelServiceInterface interface {
    UpdateNodeLabels(req interface{}, userID uint) error
    BatchUpdateLabels(req interface{}, userID uint) error
}

type TaintServiceInterface interface {
    UpdateNodeTaints(req interface{}, userID uint) error
    BatchUpdateTaints(req interface{}, userID uint) error
    RemoveTaint(clusterName, nodeName, taintKey string, userID uint) error
}
```

**æœåŠ¡é€‚é…å™¨**
```go
// services.go
type labelServiceAdapter struct {
    svc *label.Service
}

type taintServiceAdapter struct {
    svc *taint.Service
}

// é€‚é…æ–¹æ³•å®ç°
- UpdateNodeLabels()
- BatchUpdateLabels()
- UpdateNodeTaints()
- BatchUpdateTaints()
- RemoveTaint()
```

### å‘½ä»¤è·¯ç”±

**æ³¨å†Œæ–°å‘½ä»¤**
```go
// command.go
func NewCommandRouter() *CommandRouter {
    router := &CommandRouter{
        handlers: make(map[string]CommandHandler),
    }

    router.Register("help", &HelpCommandHandler{})
    router.Register("node", &NodeCommandHandler{})
    router.Register("cluster", &ClusterCommandHandler{})
    router.Register("audit", &AuditCommandHandler{})
    router.Register("label", &LabelCommandHandler{})  // âœ… æ–°å¢
    router.Register("taint", &TaintCommandHandler{})  // âœ… æ–°å¢

    return router
}
```

---

## ğŸ“ å¸®åŠ©ç³»ç»Ÿæ›´æ–°

### ä¸»å¸®åŠ©å‘½ä»¤ (/help)

æ›´æ–°äº†ä¸»å¸®åŠ©å¡ç‰‡ï¼Œæ·»åŠ äº†æ–°å‘½ä»¤è¯´æ˜ï¼š

**æ–°å¢å†…å®¹**
```
**æ ‡ç­¾ç®¡ç†å‘½ä»¤**
/label list <èŠ‚ç‚¹å> - æŸ¥çœ‹èŠ‚ç‚¹æ ‡ç­¾
/label add <èŠ‚ç‚¹å> <key>=<value> - æ·»åŠ æ ‡ç­¾
/label remove <èŠ‚ç‚¹å> <key> - åˆ é™¤æ ‡ç­¾

**æ±¡ç‚¹ç®¡ç†å‘½ä»¤**
/taint list <èŠ‚ç‚¹å> - æŸ¥çœ‹èŠ‚ç‚¹æ±¡ç‚¹
/taint add <èŠ‚ç‚¹å> <key>=<value>:<effect> - æ·»åŠ æ±¡ç‚¹
/taint remove <èŠ‚ç‚¹å> <key> - åˆ é™¤æ±¡ç‚¹

**å…¶ä»–å‘½ä»¤**
/help - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
/help label - æ ‡ç­¾ç®¡ç†å¸®åŠ©
/help taint - æ±¡ç‚¹ç®¡ç†å¸®åŠ©
```

### å­å‘½ä»¤å¸®åŠ©

**æ ‡ç­¾å¸®åŠ©** (`/help label`)
- ç”¨æ³•è¯´æ˜
- ç¤ºä¾‹å±•ç¤º
- æ ¼å¼è¦æ±‚æç¤º

**æ±¡ç‚¹å¸®åŠ©** (`/help taint`)
- ç”¨æ³•è¯´æ˜
- Effect ç±»å‹è¯¦è§£ï¼ˆå¸¦å›¾æ ‡å’Œè¯´æ˜ï¼‰
- ç¤ºä¾‹å±•ç¤º
- å®‰å…¨æç¤º

---

## ğŸ¯ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 1. æ ‡ç­¾åˆ†ç±»æ˜¾ç¤º

**ç”¨æˆ·æ ‡ç­¾** ğŸ·ï¸
- ä¼˜å…ˆæ˜¾ç¤º
- å®Œæ•´åˆ—è¡¨
- å®¹æ˜“è¯†åˆ«

**ç³»ç»Ÿæ ‡ç­¾** âš™ï¸
- æŠ˜å æ˜¾ç¤ºï¼ˆå‰5ä¸ªï¼‰
- æ˜¾ç¤ºæ€»æ•°
- å‡å°‘è§†è§‰å¹²æ‰°

### 2. æ±¡ç‚¹å¯è§†åŒ–

**Effect å›¾æ ‡**
- â›” NoScheduleï¼ˆçº¢è‰²ï¼‰
- âš ï¸ PreferNoScheduleï¼ˆé»„è‰²ï¼‰
- ğŸš« NoExecuteï¼ˆç´«è‰²ï¼‰

**Effect è¯´æ˜**
- ç®€æ´çš„åŠŸèƒ½æè¿°
- é£é™©ç­‰çº§æ ‡è¯†
- ä½¿ç”¨åœºæ™¯æç¤º

### 3. é”™è¯¯æç¤ºä¼˜åŒ–

**å‹å¥½çš„é”™è¯¯ä¿¡æ¯**
- æ¸…æ™°çš„é—®é¢˜æè¿°
- å¯æ“ä½œçš„å»ºè®®
- ç›¸å…³å‘½ä»¤å¼•å¯¼

**æŠ€æœ¯ç»†èŠ‚åˆ†ç¦»**
- ç”¨æˆ·å±‚ï¼šå‹å¥½æè¿°
- è°ƒè¯•å±‚ï¼šæŠ€æœ¯è¯¦æƒ…
- å¯é€‰æ˜¾ç¤º

---

## ğŸ“Š æµ‹è¯•åœºæ™¯

### Label å‘½ä»¤æµ‹è¯•

**æˆåŠŸåœºæ™¯**
```bash
# 1. æŸ¥çœ‹æ ‡ç­¾
/label list node-1
âœ… è¿”å›ï¼šæ ‡ç­¾åˆ—è¡¨å¡ç‰‡

# 2. æ·»åŠ å•ä¸ªæ ‡ç­¾
/label add node-1 env=production
âœ… è¿”å›ï¼šæˆåŠŸå¡ç‰‡ + æ ‡ç­¾è¯¦æƒ…

# 3. æ·»åŠ å¤šä¸ªæ ‡ç­¾
/label add node-1 app=web,version=v1.0
âœ… è¿”å›ï¼šæˆåŠŸå¡ç‰‡ + å¤šä¸ªæ ‡ç­¾è¯¦æƒ…

# 4. åˆ é™¤æ ‡ç­¾
/label remove node-1 env
âœ… è¿”å›ï¼šæˆåŠŸå¡ç‰‡ + åˆ é™¤ç¡®è®¤
```

**å¤±è´¥åœºæ™¯**
```bash
# 1. æœªé€‰æ‹©é›†ç¾¤
/label list node-1
âŒ è¿”å›ï¼šERROR_CLUSTER_NOT_SELECTED

# 2. èŠ‚ç‚¹ä¸å­˜åœ¨
/label list non-exist-node
âŒ è¿”å›ï¼šERROR_NODE_NOT_FOUND + å»ºè®®

# 3. å‚æ•°ä¸è¶³
/label add
âŒ è¿”å›ï¼šå¸®åŠ©å¡ç‰‡

# 4. æ ¼å¼é”™è¯¯
/label add node-1 invalid-format
âŒ è¿”å›ï¼šERROR_LABEL_FORMAT + æ­£ç¡®æ ¼å¼ç¤ºä¾‹
```

### Taint å‘½ä»¤æµ‹è¯•

**æˆåŠŸåœºæ™¯**
```bash
# 1. æŸ¥çœ‹æ±¡ç‚¹
/taint list node-1
âœ… è¿”å›ï¼šæ±¡ç‚¹åˆ—è¡¨å¡ç‰‡

# 2. æ·»åŠ æ±¡ç‚¹ï¼ˆNoScheduleï¼‰
/taint add node-1 dedicated=gpu:NoSchedule
âœ… è¿”å›ï¼šæˆåŠŸå¡ç‰‡ + æ±¡ç‚¹è¯¦æƒ…

# 3. åˆ é™¤æ±¡ç‚¹
/taint remove node-1 dedicated
âœ… è¿”å›ï¼šæˆåŠŸå¡ç‰‡ + åˆ é™¤ç¡®è®¤
```

**å®‰å…¨åœºæ™¯**
```bash
# 1. å°è¯•æ·»åŠ  NoExecute
/taint add node-1 maintenance=true:NoExecute
âš ï¸ è¿”å›ï¼šè­¦å‘Šå¡ç‰‡ + å®‰å…¨æç¤º
```

**å¤±è´¥åœºæ™¯**
```bash
# 1. æœªé€‰æ‹©é›†ç¾¤
/taint list node-1
âŒ è¿”å›ï¼šERROR_CLUSTER_NOT_SELECTED

# 2. å‚æ•°ä¸è¶³
/taint add
âŒ è¿”å›ï¼šå¸®åŠ©å¡ç‰‡

# 3. Effect æ— æ•ˆ
/taint add node-1 key=val:InvalidEffect
âŒ è¿”å›ï¼šERROR_TAINT_FORMAT + Effect è¯´æ˜
```

---

## ğŸ”„ ä¸ç°æœ‰åŠŸèƒ½çš„é›†æˆ

### 1. é›†ç¾¤é€‰æ‹©æœºåˆ¶

Label å’Œ Taint å‘½ä»¤å¤ç”¨ç°æœ‰çš„é›†ç¾¤é€‰æ‹©æœºåˆ¶ï¼š
- ä½¿ç”¨ `GetCurrentCluster()` è·å–ç”¨æˆ·å½“å‰é›†ç¾¤
- å¦‚æœæœªé€‰æ‹©é›†ç¾¤ï¼Œè¿”å›ç»Ÿä¸€çš„é”™è¯¯æç¤º
- å¼•å¯¼ç”¨æˆ·ä½¿ç”¨ `/cluster set` å‘½ä»¤

### 2. å®¡è®¡æ—¥å¿—

æ‰€æœ‰æ“ä½œéƒ½ä¼šè®°å½•å®¡è®¡æ—¥å¿—ï¼ˆç”±åº•å±‚æœåŠ¡å¤„ç†ï¼‰ï¼š
- ç”¨æˆ· ID
- æ“ä½œç±»å‹ï¼ˆadd/remove/updateï¼‰
- èµ„æºç±»å‹ï¼ˆlabel/taintï¼‰
- æ“ä½œç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- è¯¦ç»†ä¿¡æ¯

### 3. æƒé™éªŒè¯

å¤ç”¨ç°æœ‰çš„æƒé™æœºåˆ¶ï¼š
- åªæœ‰ç®¡ç†å‘˜è§’è‰²å¯ä»¥æ‰§è¡Œå‘½ä»¤
- ç”¨æˆ·èº«ä»½é€šè¿‡é£ä¹¦ç»‘å®šéªŒè¯
- æƒé™ä¸è¶³æ—¶ç»Ÿä¸€é”™è¯¯æç¤º

---

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### 1. æœåŠ¡è°ƒç”¨

- ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ï¼Œé¿å…ç›´æ¥ä¾èµ–
- ç±»å‹å®‰å…¨çš„è¯·æ±‚/å“åº”è½¬æ¢
- é”™è¯¯ä¼ æ’­å’Œå¤„ç†

### 2. å¡ç‰‡æ¸²æŸ“

- ç³»ç»Ÿæ ‡ç­¾æŠ˜å æ˜¾ç¤ºï¼ˆæœ€å¤šæ˜¾ç¤º5ä¸ªï¼‰
- å¤§é‡æ•°æ®æ—¶çš„åˆ†é¡µæ”¯æŒï¼ˆæœªæ¥å¯æ‰©å±•ï¼‰
- JSON åºåˆ—åŒ–ä¼˜åŒ–

---

## ğŸš€ éƒ¨ç½²è¯´æ˜

### æ–°å¢æ–‡ä»¶

```
backend/internal/service/feishu/
â”œâ”€â”€ command_label.go     âœ… Label å‘½ä»¤å¤„ç†å™¨
â”œâ”€â”€ command_taint.go     âœ… Taint å‘½ä»¤å¤„ç†å™¨
â””â”€â”€ errors.go            âœ… é”™è¯¯å¤„ç†ç»“æ„
```

### ä¿®æ”¹æ–‡ä»¶

```
backend/internal/service/feishu/
â”œâ”€â”€ feishu.go            âœ… æ·»åŠ æœåŠ¡æ¥å£
â”œâ”€â”€ command.go           âœ… æ³¨å†Œæ–°å‘½ä»¤
â”œâ”€â”€ command_help.go      âœ… æ›´æ–°å¸®åŠ©ç³»ç»Ÿ
â””â”€â”€ card_builder.go      âœ… æ·»åŠ æ–°å¡ç‰‡å’Œå¢å¼ºé”™è¯¯å¡ç‰‡

backend/internal/service/
â””â”€â”€ services.go          âœ… æ·»åŠ æœåŠ¡é€‚é…å™¨
```

### æ•°æ®åº“å˜æ›´

**æ— éœ€æ•°æ®åº“å˜æ›´** - å¤ç”¨ç°æœ‰è¡¨ç»“æ„

### é…ç½®å˜æ›´

**æ— éœ€é…ç½®å˜æ›´** - ä½¿ç”¨ç°æœ‰é…ç½®

---

## ğŸ‰ æ€»ç»“

### å·²å®ç°

âœ… **Label ç®¡ç†å‘½ä»¤** - å®Œæ•´å®ç°  
âœ… **Taint ç®¡ç†å‘½ä»¤** - å®Œæ•´å®ç°  
âœ… **é”™è¯¯å¤„ç†æ”¹è¿›** - ç»“æ„åŒ–é”™è¯¯å’Œå¢å¼ºå¡ç‰‡  
âœ… **å®‰å…¨å¢å¼º** - NoExecute è­¦å‘Šæœºåˆ¶  

### åŠŸèƒ½äº®ç‚¹

1. **å®Œæ•´çš„å‘½ä»¤é›†** - list/add/remove æ“ä½œ
2. **åˆ†ç±»å±•ç¤º** - ç”¨æˆ·æ ‡ç­¾å’Œç³»ç»Ÿæ ‡ç­¾åŒºåˆ†
3. **å¯è§†åŒ–** - Effect å›¾æ ‡å’Œé¢œè‰²ç¼–ç 
4. **å®‰å…¨æœºåˆ¶** - å±é™©æ“ä½œè­¦å‘Š
5. **å‹å¥½é”™è¯¯** - ç»“æ„åŒ–é”™è¯¯å’Œè§£å†³å»ºè®®
6. **å¸®åŠ©ç³»ç»Ÿ** - è¯¦ç»†çš„ç”¨æ³•è¯´æ˜å’Œç¤ºä¾‹
7. **å®¡è®¡é›†æˆ** - è‡ªåŠ¨è®°å½•æ‰€æœ‰æ“ä½œ
8. **æƒé™æ§åˆ¶** - ç®¡ç†å‘˜æƒé™éªŒè¯

### æŠ€æœ¯è´¨é‡

- âœ… ä»£ç ç»“æ„æ¸…æ™°
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… ç±»å‹å®‰å…¨
- âœ… å¯æ‰©å±•æ€§å¥½
- âœ… æ–‡æ¡£å®Œæ•´
- âœ… æ—  Lint é”™è¯¯

---

**å®æ–½å®Œæˆæ—¶é—´**: 2024-10-21  
**å®æ–½çŠ¶æ€**: âœ… å®Œæˆ  
**åç»­ä»»åŠ¡**: ä¸­ä¼˜å…ˆçº§åŠŸèƒ½ï¼ˆæ‰¹é‡æ“ä½œã€äº¤äº’å¼æŒ‰é’®ç­‰ï¼‰

